<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RandomSeats</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
/* 회전 대응 wrapper */
.seat-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
}
.seat-wrapper.rotate-left {
  transform: rotate(90deg);
}
.seat-wrapper.rotate-right {
  transform: rotate(-90deg);
}

    html, body {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }
    
    /* 다크모드 지원 (시스템 설정 기반) */
    @media (prefers-color-scheme: dark) {
      html, body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      }
      
      #seat-container {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      #seat-container::after {
        color: #666;
      }
      
      /* 다이나믹 아일랜드 */
      #dynamic-island {
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      
      /* 버튼들 */
      .button {
        background: rgba(50, 50, 50, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      
      .button:hover {
        background: rgba(70, 70, 70, 0.95);
      }
      
      /* 모달 배경 */
      .modal {
        background: rgba(0, 0, 0, 0.8);
      }
      
      /* 모달 박스 */
      .modal-box {
        background: #2d2d2d;
        color: #e0e0e0;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      }
      
      .modal-box h2 {
        color: #e0e0e0;
      }
      
      .modal-box p {
        color: #b0b0b0;
      }
      
      .modal-box label {
        color: #b0b0b0;
      }
      
      .modal-box label:hover {
        color: #d0d0d0;
      }
      
      /* 체크박스 */
      .modal-box input[type="checkbox"] {
        filter: brightness(1.2);
      }
      
      .modal-box ul {
        color: #b0b0b0;
      }
      
      .modal-box ul li {
        color: #b0b0b0;
      }
      
      /* 모달 버튼 */
      .modal-box button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #ffffff;
      }
      
      .modal-box button:hover {
        background: linear-gradient(135deg, #7c8ef5, #8558b3);
      }
      
      /* 특수 버튼들 */
      .modal-box button[id*="close"],
      .modal-box button[id*="cancel"] {
        background: #3a3a3a;
        color: #b0b0b0;
      }
      
      .modal-box button[id*="close"]:hover,
      .modal-box button[id*="cancel"]:hover {
        background: #4a4a4a;
        color: #e0e0e0;
      }
      
      .modal-box button[id*="delete"],
      .modal-box button[id*="logout"] {
        background: #dc2626;
      }
      
      .modal-box button[id*="delete"]:hover,
      .modal-box button[id*="logout"]:hover {
        background: #b91c1c;
      }
      
      /* 배경이 있는 영역 */
      .modal-box div[style*="background"] {
        background: #3a3a3a !important;
      }
      
      /* 별점 시스템 */
      .star {
        filter: brightness(1.2);
      }
      
      /* Strong 태그 */
      .modal-box strong {
        color: #e0e0e0;
      }
      
      /* 계정 정보 박스 */
      .modal-box div[style*="#f9fafb"] {
        background: #3a3a3a !important;
        border: 1px solid #555;
      }
      
      /* PRO 상태 표시 */
      .modal-box span[style*="#f59e0b"] {
        color: #fbbf24 !important;
      }
      
      .modal-box span[style*="#059669"] {
        color: #10b981 !important;
      }
      
      /* 입력 필드 */
      .modal-box input[type="text"],
      .modal-box input[type="email"],
      .modal-box input[type="password"],
      .modal-box input[type="checkbox"],
      .modal-box textarea {
        background: #3a3a3a;
        color: #e0e0e0;
        border-color: #555;
      }
      
      .modal-box input[type="text"]:focus,
      .modal-box input[type="email"]:focus,
      .modal-box input[type="password"]:focus,
      .modal-box textarea:focus {
        border-color: #667eea;
        background: #404040;
      }
      
      .modal-box input[type="text"]::placeholder,
      .modal-box input[type="email"]::placeholder,
      .modal-box input[type="password"]::placeholder,
      .modal-box textarea::placeholder {
        color: #888;
      }
      
      /* 에러 메시지 */
      .error-message {
        color: #ff6b6b;
      }
      
      /* 링크 */
      .modal-box a {
        color: #a78bfa;
      }
      
      .modal-box a:hover {
        color: #c4b5fd;
      }
      
      /* 프로모션 바 (다크모드에서는 약간 어둡게) */
      .promo-bar {
        filter: brightness(0.85);
      }
    }
    
    #wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      transition: all 0.3s ease;
    }
    
    /* PRO 활성화시 중앙 정렬 */
    #wrapper.pro-active {
      justify-content: center;
    }

    /* 쌤 뷰 적용 시 좌석 컨테이너만 회전 */
    #wrapper.teacher-view #seat-container {
      transform: rotate(180deg);
    }

    /* 쌤 뷰 적용 시 텍스트는 다시 정상 방향으로 회전 */
    #wrapper.teacher-view .seat,
    #wrapper.teacher-view .desk {
      transform: rotate(180deg);
    }

    /* 다이나믹 아일랜드는 항상 정상 방향 유지 */
    #wrapper.teacher-view #dynamic-island {
      transform: none;
    }
    
    #dynamic-island {
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      animation: fadeInUp 0.6s ease-out;
    }
    
    .button {
      width: 44px;
      height: 44px;
      background: rgba(60, 60, 60, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      color: #ffffff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .button:hover {
      background: rgba(80, 80, 80, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .button:hover::before {
      left: 100%;
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    /* 왕관 버튼 (PRO) */
    .button.crown {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border: 2px solid #fbbf24;
    }
    
    .button.crown.pro {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .button.crown:hover {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    
    .button.crown.pro:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    #seat-container {
    display: grid;
    grid-template-columns: repeat(8, 60px);
    gap: 16px;
    padding: 32px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
    animation: fadeInUp 0.8s ease-out;
      position: relative;
      }
      
      /* 저작권 표시 */
      #seat-container::after {
        content: '© 2025 Eunsung Lee';
        position: absolute;
        bottom: 8px;
        right: 12px;
        font-size: 11px;
        color: #999;
        font-family: 'Inter', Arial, sans-serif;
        pointer-events: none;
      }
    
    .seat {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 600;
      font-size: 11px;
      user-select: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      text-align: center;
      line-height: 1.1;
    }
    
    .seat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
      border-radius: 14px;
    }
    
    .seat.male {
      background: linear-gradient(135deg, #667eea, #4facfe);
      box-shadow: 
        0 8px 16px rgba(102, 126, 234, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .seat.female {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      box-shadow: 
        0 8px 16px rgba(240, 147, 251, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .seat:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 
        0 12px 24px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .seat.dragging {
      opacity: 0.5;
      transform: rotate(5deg) scale(1.1);
      z-index: 1000;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .seat.drag-over {
      border: 3px solid #4ade80;
      box-shadow: 
        0 0 20px rgba(74, 222, 128, 0.4),
        0 12px 24px rgba(0, 0, 0, 0.15);
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { 
        border-color: #4ade80;
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
      }
      50% { 
        border-color: #22c55e;
        box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
      }
    }
    
    .empty {
      width: 60px;
      height: 60px;
    }
    
/* 교탁: 색상만 변경 */
.desk {
  grid-column: span 2;
  height: 60px;
  border-radius: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #ffffff;
  font-weight: 700;
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;

  /* 🎨 원하는 색상 팔레트 */
  background: linear-gradient(135deg, #6a11cb, #2575fc); /* 보라→파랑 */
  box-shadow:
    0 8px 16px rgba(37, 117, 252, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);

  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.desk::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
  border-radius: 14px;
}

.desk:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow:
    0 12px 24px rgba(0, 0, 0, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-box {
      background: white;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      max-height: 80vh;
      width: 90%;
      text-align: left;
      animation: scaleIn 0.3s ease-out;
      overflow-y: auto;
    }
    
    .modal-box h2 {
      margin-bottom: 20px;
      color: #2d3748;
      font-weight: 700;
      font-size: 20px;
    }
    
    .modal-box label {
      font-weight: 500;
      display: block;
      margin-bottom: 16px;
      cursor: pointer;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .modal-box input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .modal-box button {
      margin-top: 20px;
      padding: 12px 24px;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .modal-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    .modal-box p {
      line-height: 1.6;
      color: #4a5568;
      margin-bottom: 16px;
    }
    
    /* 이미지 저장용 임시 컨테이너 스타일 */
    #temp-container {
      position: fixed;
      top: -9999px;
      left: -9999px;
      background: white;
      padding: 32px;
      border-radius: 20px;
      display: grid;
      grid-template-columns: repeat(8, 60px);
      gap: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* 프로모션 하단 바 스타일 - 단색 배경으로 변경 */
    .promo-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: stretch;
      z-index: 9999;
      min-height: 70px;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    
    .promo-bar.hidden {
      display: none;
    }
    
    .promo-slide {
      display: none;
      align-items: center;
      justify-content: flex-start;
      padding: 0 40px;
      animation: fadeIn 0.5s ease-in-out;
      position: relative;
      width: 100%;
      height: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .promo-slide:hover {
      filter: brightness(1.1);
    }
    
    .promo-emoji {
      position: absolute;
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
    }
    
    /* GitHub Star - 노란색 */
    .promo-slide:nth-child(1) {
      background: #fbbf24;
    }
    
    /* RandomPicker - 파란색 */
    .promo-slide:nth-child(2) {
      background: #3b82f6;
    }
    
    /* Coffee - 갈색 */
    .promo-slide:nth-child(3) {
      background: #92400e;
    }
    
    /* Feedback - 핑크색 */
    .promo-slide:nth-child(4) {
      background: #ec4899;
    }
    
    /* Follow - 보라색 */
    .promo-slide:nth-child(5) {
      background: #8b5cf6;
    }
    
    /* RandomSeats Pro - 황금색 */
    .promo-slide:nth-child(6) {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .promo-slide.active {
      display: flex;
    }
    
    .promo-content {
      display: flex;
      align-items: center;
      gap: 16px;
      width: auto;
      height: 100%;
      padding: 16px 0;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 22px;
      z-index: 1;
      position: relative;
    }
    

    
    .promo-icon {
      font-size: 48px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
    }
    
    /* 하단 광고바 공간 확보 */
    body {
      padding-bottom: 110px;
    }
    
    /* PRO 활성화시 공간 제거 */
    body.pro-active {
      padding-bottom: 0;
    }
    
    .modal-box input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 8px;
      transition: border-color 0.3s;
    }
    
    .modal-box input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .captcha-container {
      margin: 16px 0;
      display: flex;
      justify-content: center;
    }
    
    .error-message {
      color: #e53e3e;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      #seat-container {
        grid-template-columns: repeat(8, 50px);
        gap: 12px;
        padding: 24px;
      }
      
      .seat, .empty {
        width: 50px;
        height: 50px;
        font-size: 10px;
      }
      
      .button {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      #dynamic-island {
        gap: 8px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
<div id="wrapper">
  <div id="dynamic-island">
<div class="button crown" id="crown-button" title="Upgrade to PRO"><i class="fa-solid fa-crown"></i></div>
<div class="button" id="start-button" title="Shuffle"><i class="fa-solid fa-play"></i></div>
<div class="button" id="reset-button" title="Clear"><i class="fa-solid fa-rotate-left"></i></div>
<div class="button" id="photo-button" title="Export"><i class="fa-solid fa-save"></i></div>
<div class="button" id="upload-button" title="Import JSON"><i class="fa-solid fa-file-upload"></i></div>
<div class="button" id="account-button" title="Account"><i class="fa-solid fa-user"></i></div>
<div class="button" id="settings-button" title="Settings"><i class="fa-solid fa-gear"></i></div>
<div class="button" id="bug-button" title="Feedback" onclick="location.href='mailto:eunsung_lee@hotmail.com'"><i class="fa-solid fa-bug"></i></div>
<div class="button" id="info-button" title="About"><i class="fa-solid fa-circle-info"></i></div>

  </div>

  <div id="seat-container"></div>
  
</div>

<!-- Promotion Bar -->
<div class="promo-bar">
  <div class="promo-slide active" data-emoji="⭐">
    <span class="promo-emoji" style="font-size: 100px; left: 5%; top: -30px; transform: rotate(-15deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 70px; right: 15%; top: -10px; transform: rotate(20deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 50px; left: 30%; top: -5px; transform: rotate(-25deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 60px; right: 35%; top: -18px; transform: rotate(15deg);">⭐</span>
    <a href="https://github.com/codemaster0524/RandomSeats" target="_blank" class="promo-content">
      <span class="promo-icon">⭐</span>
      <span>Star this project on GitHub</span>
    </a>
  </div>
  <div class="promo-slide" data-emoji="🎲">
    <span class="promo-emoji" style="font-size: 90px; left: 10%; top: -25px; transform: rotate(10deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 65px; right: 8%; top: -20px; transform: rotate(-10deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 55px; left: 35%; top: -8px; transform: rotate(25deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 75px; right: 30%; top: -15px; transform: rotate(-20deg);">🎲</span>
    <a href="https://codemaster0524.github.io/RandomPicker" target="_blank" class="promo-content">
      <span class="promo-icon">🎲</span>
      <span>Try RandomPicker</span>
    </a>
  </div>
  <div class="promo-slide" data-emoji="☕">
    <span class="promo-emoji" style="font-size: 95px; left: 7%; top: -28px; transform: rotate(-12deg);">☕</span>
    <span class="promo-emoji" style="font-size: 75px; right: 10%; top: -12px; transform: rotate(-15deg);">☕</span>
    <span class="promo-emoji" style="font-size: 58px; left: 32%; top: -10px; transform: rotate(18deg);">☕</span>
    <span class="promo-emoji" style="font-size: 68px; right: 33%; top: -20px; transform: rotate(-8deg);">☕</span>
    <div class="promo-content" onclick="showCoffeeModal()">
      <span class="promo-icon">☕</span>
      <span>Buy me a coffee</span>
    </div>
  </div>
  <div class="promo-slide" data-emoji="💌">
    <span class="promo-emoji" style="font-size: 85px; left: 12%; top: -22px; transform: rotate(12deg);">💌</span>
    <span class="promo-emoji" style="font-size: 68px; right: 18%; top: -18px; transform: rotate(-18deg);">💌</span>
    <span class="promo-emoji" style="font-size: 52px; left: 28%; top: -6px; transform: rotate(-22deg);">💌</span>
    <span class="promo-emoji" style="font-size: 72px; right: 28%; top: -14px; transform: rotate(8deg);">💌</span>
    <div class="promo-content" onclick="showFeedbackModal()">
      <span class="promo-icon">💌</span>
      <span>Leave feedback & rating</span>
    </div>
  </div>
  <div class="promo-slide" data-emoji="👤">
    <span class="promo-emoji" style="font-size: 92px; left: 6%; top: -26px; transform: rotate(-20deg);">👤</span>
    <span class="promo-emoji" style="font-size: 72px; right: 14%; top: -14px; transform: rotate(15deg);">👤</span>
    <span class="promo-emoji" style="font-size: 56px; left: 30%; top: -12px; transform: rotate(20deg);">👤</span>
    <span class="promo-emoji" style="font-size: 66px; right: 32%; top: -22px; transform: rotate(-12deg);">👤</span>
    <a href="https://github.com/codemaster0524" target="_blank" class="promo-content">
      <span class="promo-icon">👤</span>
      <span>Follow me on GitHub</span>
    </a>
  </div>
  <div class="promo-slide" data-emoji="👑" onclick="document.getElementById('crown-button').click()">
    <span class="promo-emoji" style="font-size: 100px; left: 8%; top: -30px; transform: rotate(-18deg);">👑</span>
    <span class="promo-emoji" style="font-size: 80px; right: 12%; top: -20px; transform: rotate(22deg);">👑</span>
    <span class="promo-emoji" style="font-size: 60px; left: 35%; top: -10px; transform: rotate(-15deg);">👑</span>
    <span class="promo-emoji" style="font-size: 70px; right: 30%; top: -25px; transform: rotate(12deg);">👑</span>
    <div class="promo-content">
      <span class="promo-icon">👑</span>
      <span>Try RandomSeats Pro</span>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>

function createFavicons() {
  const timestamp = Date.now();

  const lightFavicon = document.createElement('link');
  lightFavicon.rel = 'icon';
  lightFavicon.type = 'image/svg+xml';
  lightFavicon.media = '(prefers-color-scheme: light)';
  lightFavicon.href = `https://codemaster0524.github.io/RandomSeats/favicon.svg?v=${timestamp}`;

  const darkFavicon = document.createElement('link');
  darkFavicon.rel = 'icon';
  darkFavicon.type = 'image/svg+xml';
  darkFavicon.media = '(prefers-color-scheme: dark)';
  darkFavicon.href = `https://codemaster0524.github.io/RandomSeats/favicon-dark.svg?v=${timestamp}`;

  document.head.appendChild(lightFavicon);
  document.head.appendChild(darkFavicon);
}
createFavicons();

// 페이지 로드시 실행
createFavicons();

let deskVisible = true;
let teacherView = false;
let currentSeatAssignment = null;
let draggedSeat = null;
let isPro = false;
let turnstileWidgetId = null;
let currentUser = null; // 현재 로그인된 사용자

// Cloudflare Workers API URL
const WORKER_API_URL = 'https://ad-keys.eunsung-lee-460.workers.dev/'; // 꼭 슬래시!
const AUTH_API_URL = 'https://ad-keys.eunsung-lee-460.workers.dev/auth'; // Auth 엔드포인트
const TURNSTILE_SITE_KEY = '0x4AAAAAAB6AJ6Melx1ZJUyZ'; // Turnstile 사이트 키

// 비밀번호 유효성 검사 함수
function validatePassword(password) {
  const errors = [];
  
  // 최소 8자 이상
  if (password.length < 8) {
    errors.push('At least 8 characters');
  }
  
  // 대문자 포함
  if (!/[A-Z]/.test(password)) {
    errors.push('At least one uppercase letter (A-Z)');
  }
  
  // 소문자 포함
  if (!/[a-z]/.test(password)) {
    errors.push('At least one lowercase letter (a-z)');
  }
  
  // 숫자 포함
  if (!/[0-9]/.test(password)) {
    errors.push('At least one number (0-9)');
  }
  
  // 특수문자 포함
  if (!/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password)) {
    errors.push('At least one special character (!@#$%^&*...)');;
  }
  
  return {
    isValid: errors.length === 0,
    errors: errors
  };
}

// 비밀번호 강도 표시 함수
function getPasswordStrength(password) {
  let strength = 0;
  
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[a-z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password)) strength++;
  
  if (strength <= 2) return { level: 'weak', color: '#ef4444', text: 'Weak' };
  if (strength <= 4) return { level: 'medium', color: '#f59e0b', text: 'Medium' };
  return { level: 'strong', color: '#10b981', text: 'Strong' };
}

// 페이지 로드시 PRO 상태 확인 (localStorage 사용)
if (localStorage.getItem('isPro') === 'true') {
  isPro = true;
  const promoBar = document.querySelector('.promo-bar');
  if (promoBar) promoBar.classList.add('hidden');
  const crownButton = document.getElementById('crown-button');
  if (crownButton) crownButton.classList.add('pro');
  document.body.classList.add('pro-active');
  document.getElementById('wrapper').classList.add('pro-active');
}

// 페이지 로드시 로그인 상태 확인
const savedUser = localStorage.getItem('currentUser');
if (savedUser) {
  try {
    currentUser = JSON.parse(savedUser);
    updateAccountButton();
  } catch (e) {
    localStorage.removeItem('currentUser');
  }
}

// 계정 버튼 UI 업데이트
function updateAccountButton() {
  const accountButton = document.getElementById('account-button');
  if (currentUser) {
    accountButton.innerHTML = '<i class="fa-solid fa-user-check"></i>';
    accountButton.title = `Logged in as ${currentUser.name || currentUser.email}`;
    accountButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
  } else {
    accountButton.innerHTML = '<i class="fa-solid fa-user"></i>';
    accountButton.title = 'Account';
    accountButton.style.background = '';
  }
}

// 프로모션 슬라이드 자동 전환 (5초마다)
let currentSlide = 0;
const slides = document.querySelectorAll('.promo-slide');
const promoBar = document.querySelector('.promo-bar');

function showSlide(index) {
  slides.forEach((slide, i) => {
    slide.classList.remove('active');
    if (i === index) {
      slide.classList.add('active');
      // 프로모션 바 배경색 변경
      const bgColor = window.getComputedStyle(slide).backgroundColor;
      promoBar.style.background = bgColor;
    }
  });
}

// 초기 배경색 설정
if (slides.length > 0 && !isPro) {
  const initialBgColor = window.getComputedStyle(slides[0]).backgroundColor;
  promoBar.style.background = initialBgColor;
}

function nextSlide() {
  if (!isPro) {
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
  }
}

setInterval(nextSlide, 5000);

const pattern = [
  'XXITTIXX',
  'OQIOQIOQ',
  'QOIQOIQO',
  'OQIOQIOQ',
  'QOIQOIQO',
  'OQIOOIOQ'
];

const entries = [
  {name: '강태경', gender: 'male'}, {name: '고 율', gender: 'female'},
  {name: '권하은', gender: 'female'}, {name: '김민서', gender: 'female'},
  {name: '김민지', gender: 'female'}, {name: '김윤환', gender: 'male'},
  {name: '류선우', gender: 'male'}, {name: '박종훈', gender: 'male'},
  {name: '박주형', gender: 'male'}, {name: '박지호', gender: 'male'},
  {name: '양서진', gender: 'male'}, {name: '오수빈', gender: 'male'},
  {name: '유은지', gender: 'female'}, {name: '윤경진', gender: 'male'},
  {name: '윤선유', gender: 'female'}, {name: '이소은', gender: 'female'},
  {name: '이은성', gender: 'male'}, {name: '이하윤', gender: 'female'},
  {name: '이현민', gender: 'male'}, {name: '정시목', gender: 'male'},
  {name: '정유현', gender: 'female'}, {name: '정재현', gender: 'male'},
  {name: '정해주', gender: 'female'}, {name: '조수아', gender: 'female'},
  {name: '진혜원', gender: 'female'}, {name: '천마루', gender: 'male'},
  {name: '최선우', gender: 'male'}, {name: '하지현', gender: 'female'},
  {name: '황은아', gender: 'female'}, {name: '황지운', gender: 'male'}
];

const seatContainer = document.getElementById('seat-container');
const startButton = document.getElementById('start-button');
const resetButton = document.getElementById('reset-button');
const photoButton = document.getElementById('photo-button');
const settingsButton = document.getElementById('settings-button');
const infoButton = document.getElementById('info-button');
const wrapper = document.getElementById('wrapper');

function renderEmptySeats() {
  seatContainer.innerHTML = '';
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        seatContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          seatContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.classList.add('desk');
        desk.textContent = '교탁';
        seatContainer.appendChild(desk);
        continue;
      }
      const seat = document.createElement('div');
      seat.classList.add('seat');
      if (ch === 'Q') seat.classList.add('female');
      else if (ch === 'O') seat.classList.add('male');
      seat.textContent = '';
      seatContainer.appendChild(seat);
    }
  }
}

function renderSeatsWithAssignment() {
  seatContainer.innerHTML = '';
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        seatContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          seatContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.classList.add('desk');
        desk.textContent = '교탁';
        seatContainer.appendChild(desk);
        continue;
      }

      const seat = document.createElement('div');
      seat.classList.add('seat');
      if (ch === 'Q') seat.classList.add('female');
      else if (ch === 'O') seat.classList.add('male');

      const occupant = currentSeatAssignment ? currentSeatAssignment[row][col] : null;
      seat.textContent = occupant ? occupant.name : '';

      if (occupant) {
        seat.draggable = true;
        seat.dataset.row = row;
        seat.dataset.col = col;
        seat.dataset.gender = occupant.gender;
        
        seat.addEventListener('dragstart', handleDragStart);
        seat.addEventListener('dragover', handleDragOver);
        seat.addEventListener('drop', handleDrop);
        seat.addEventListener('dragend', handleDragEnd);
        
        seat.style.cursor = 'grab';
      }

      seatContainer.appendChild(seat);
    }
  }
}

function assignSeats() {
  const maleSeats = [], femaleSeats = [];
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'O') maleSeats.push({row, col});
      else if (ch === 'Q') femaleSeats.push({row, col});
    }
  }

  const males = entries.filter(e => e.gender === 'male');
  const females = entries.filter(e => e.gender === 'female');
  const shuffle = arr => arr.sort(() => Math.random() - 0.5);
  const shuffledMales = shuffle([...males]);
  const shuffledFemales = shuffle([...females]);

  const seatMap = Array(pattern.length).fill(null).map(() => Array(pattern[0].length).fill(null));
  for (let i = 0; i < maleSeats.length; i++) {
    if (i < shuffledMales.length)
      seatMap[maleSeats[i].row][maleSeats[i].col] = shuffledMales[i];
  }
  for (let i = 0; i < femaleSeats.length; i++) {
    if (i < shuffledFemales.length)
      seatMap[femaleSeats[i].row][femaleSeats[i].col] = shuffledFemales[i];
  }

  currentSeatAssignment = seatMap;
  renderSeatsWithAssignment();
}

// 드래그 앤 드롭 이벤트 핸들러들
function handleDragStart(e) {
  draggedSeat = {
    row: parseInt(e.target.dataset.row),
    col: parseInt(e.target.dataset.col),
    gender: e.target.dataset.gender,
    element: e.target
  };
  e.target.classList.add('dragging');
  e.target.style.cursor = 'grabbing';
}

function handleDragOver(e) {
  e.preventDefault();
  const targetGender = e.target.dataset.gender;
  
  if (draggedSeat && targetGender && draggedSeat.gender === targetGender) {
    e.target.classList.add('drag-over');
  }
}

function handleDrop(e) {
  e.preventDefault();
  
  if (!draggedSeat || !e.target.dataset.gender) return;
  
  const targetRow = parseInt(e.target.dataset.row);
  const targetCol = parseInt(e.target.dataset.col);
  const targetGender = e.target.dataset.gender;
  
  if (draggedSeat.gender === targetGender) {
    const temp = currentSeatAssignment[draggedSeat.row][draggedSeat.col];
    currentSeatAssignment[draggedSeat.row][draggedSeat.col] = currentSeatAssignment[targetRow][targetCol];
    currentSeatAssignment[targetRow][targetCol] = temp;
    
    renderSeatsWithAssignment();
  }
  
  cleanupDragState();
}

function handleDragEnd(e) {
  cleanupDragState();
}

function cleanupDragState() {
  if (draggedSeat) {
    draggedSeat.element.classList.remove('dragging');
    draggedSeat.element.style.cursor = 'grab';
  }
  
  document.querySelectorAll('.drag-over').forEach(seat => {
    seat.classList.remove('drag-over');
  });
  
  draggedSeat = null;
}

// 이미지 저장을 위한 임시 컨테이너 생성 함수
function createTempContainer() {
  const tempContainer = document.createElement('div');
  tempContainer.id = 'temp-container';
  
  // 쌤 뷰가 활성화되어 있으면 임시 컨테이너도 회전
  if (teacherView) {
    tempContainer.style.transform = 'rotate(180deg)';
  }
  
  // 현재 좌석 배치를 복사
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.style.width = '60px';
        empty.style.height = '60px';
        tempContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.style.width = '60px';
          empty.style.height = '60px';
          tempContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.style.cssText = `
          grid-column: span 2;
          height: 60px;
          border-radius: 16px;
          display: flex;
          justify-content: center;
          align-items: center;
          color: #ffffff;
          font-weight: 700;
          font-size: 14px;
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          box-shadow: 0 8px 16px rgba(37, 117, 252, 0.3);
          ${teacherView ? 'transform: rotate(180deg);' : ''}
        `;
        desk.textContent = '교탁';
        tempContainer.appendChild(desk);
        continue;
      }

      const seat = document.createElement('div');
      seat.style.cssText = `
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        font-size: 11px;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        text-align: center;
        line-height: 1.1;
        ${teacherView ? 'transform: rotate(180deg);' : ''}
      `;
      
      if (ch === 'Q') {
        seat.style.background = 'linear-gradient(135deg, #f093fb, #f5576c)';
        seat.style.boxShadow = '0 8px 16px rgba(240, 147, 251, 0.3)';
      } else if (ch === 'O') {
        seat.style.background = 'linear-gradient(135deg, #667eea, #4facfe)';
        seat.style.boxShadow = '0 8px 16px rgba(102, 126, 234, 0.3)';
      }

      const occupant = currentSeatAssignment ? currentSeatAssignment[row][col] : null;
      seat.textContent = occupant ? occupant.name : '';

      tempContainer.appendChild(seat);
    }
  }
  
  document.body.appendChild(tempContainer);
  return tempContainer;
}

const crownButton = document.getElementById('crown-button');
const uploadButton = document.getElementById('upload-button');
const accountButton = document.getElementById('account-button');

// 계정 버튼 클릭
accountButton.onclick = () => {
  if (currentUser) {
    // 로그인 되어있으면 계정 정보 표시
    const modal = document.createElement('div');
    modal.className = 'modal';
    const box = document.createElement('div');
    box.className = 'modal-box';
    box.innerHTML = `
      <h2>👤 Account</h2>
      <p style="font-size: 14px; color: #059669; font-weight: 600; margin-bottom: 16px;">
        ✅ Logged in as ${currentUser.name || currentUser.email}
      </p>
      <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
        <p style="margin-bottom: 8px;"><strong>Email:</strong> ${currentUser.email}</p>
        <p style="margin-bottom: 8px;"><strong>Provider:</strong> ${currentUser.provider}</p>
        <p><strong>PRO Status:</strong> ${isPro ? '<span style="color: #f59e0b;">👑 Active</span>' : 'Free'}</p>
      </div>
      <button id="change-password-button" style="background: #3b82f6; margin-top: 12px;">🔑 Change Password</button>
      <button id="forgot-password-button" style="background: #8b5cf6; margin-top: 12px;">🔐 Forgot Password</button>
      <button id="logout-button" style="background: #ef4444; margin-top: 12px;">🚪 Logout</button>
      <button id="delete-account-button" style="background: #991b1b; margin-top: 12px;">🗑️ Delete Account</button>
      <button id="close-account">Close</button>
    `;
    modal.appendChild(box);
    document.body.appendChild(modal);
    
    box.querySelector('#change-password-button').onclick = () => {
      document.body.removeChild(modal);
      handleChangePassword();
    };
    
    box.querySelector('#forgot-password-button').onclick = () => {
      document.body.removeChild(modal);
      handleForgotPassword();
    };
    
    box.querySelector('#logout-button').onclick = () => {
      currentUser = null;
      isPro = false;
      localStorage.removeItem('currentUser');
      localStorage.removeItem('isPro');
      updateAccountButton();
      document.body.removeChild(modal);
      
      // PRO 상태 해제
      const promoBar = document.querySelector('.promo-bar');
      if (promoBar) promoBar.classList.remove('hidden');
      const crownBtn = document.getElementById('crown-button');
      if (crownBtn) crownBtn.classList.remove('pro');
      document.body.classList.remove('pro-active');
      document.getElementById('wrapper').classList.remove('pro-active');
    };
    
    box.querySelector('#delete-account-button').onclick = () => {
      document.body.removeChild(modal);
      handleDeleteAccount();
    };
    
    box.querySelector('#close-account').onclick = () => document.body.removeChild(modal);
  } else {
    // 로그인 안되어있으면 로그인 옵션 표시
    const modal = document.createElement('div');
    modal.className = 'modal';
    const box = document.createElement('div');
    box.className = 'modal-box';
    box.innerHTML = `
      <h2>👤 Sign In</h2>
      <p>Sign in to sync your PRO status across devices.</p>
      <button id="google-login" style="background: #4285f4; margin-top: 20px;">
        <i class="fa-brands fa-google"></i> Sign in with Google
      </button>
      <button id="email-login" style="background: #10b981; margin-top: 12px;">
        <i class="fa-solid fa-envelope"></i> Sign in with Email
      </button>
      <button id="microsoft-login" style="background: #0078d4; margin-top: 12px;">
        <i class="fa-brands fa-microsoft"></i> Sign in with Microsoft
      </button>
      <button id="github-login" style="background: #333; margin-top: 12px;">
        <i class="fa-brands fa-github"></i> Sign in with GitHub
      </button>
      <button id="close-login" style="background: #e2e8f0; color: #4a5568; margin-top: 12px;">Cancel</button>
    `;
    modal.appendChild(box);
    document.body.appendChild(modal);
    
    box.querySelector('#google-login').onclick = () => {
      document.body.removeChild(modal);
      handleOAuthLogin('google');
    };
    
    box.querySelector('#email-login').onclick = () => {
      document.body.removeChild(modal);
      handleEmailLogin();
    };
    
    box.querySelector('#microsoft-login').onclick = () => {
      document.body.removeChild(modal);
      showModal('🚧 Coming Soon', '<p>Microsoft login is currently under development.</p><p>Please use Google, Email, or GitHub login instead.</p>');
    };
    
    box.querySelector('#github-login').onclick = () => {
      document.body.removeChild(modal);
      handleOAuthLogin('github');
    };
    
    box.querySelector('#close-login').onclick = () => document.body.removeChild(modal);
  }
};

// 비밀번호 재설정 처리 (비밀번호 잊어버림)
async function handleForgotPassword() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  
  box.innerHTML = `
    <h2>🔐 Forgot Password</h2>
    <p style="margin-bottom: 16px;">Enter your email to receive a password reset code.</p>
    <input type="email" id="reset-email" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
    <div class="captcha-container" id="reset-captcha-container">
      <div id="reset-turnstile-widget"></div>
    </div>
    <div class="error-message" id="reset-error"></div>
    <button id="send-reset-code" style="background: #8b5cf6; margin-top: 12px;">Send Reset Code</button>
    <button id="cancel-reset" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  let resetTurnstileId;
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      resetTurnstileId = turnstile.render('#reset-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      });
    }
  }, 100);
  
  const emailInput = box.querySelector('#reset-email');
  const sendBtn = box.querySelector('#send-reset-code');
  const cancelBtn = box.querySelector('#cancel-reset');
  const errorMsg = box.querySelector('#reset-error');
  
  sendBtn.onclick = async () => {
    const email = emailInput.value.trim();
    
    if (!email) {
      errorMsg.textContent = 'Email required';
      errorMsg.classList.add('show');
      return;
    }
    
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(resetTurnstileId);
      if (!captchaToken) {
        errorMsg.textContent = 'Please complete the captcha';
        errorMsg.classList.add('show');
        return;
      }
    } catch (e) {
      errorMsg.textContent = 'Captcha error. Please refresh the page.';
      errorMsg.classList.add('show');
      return;
    }
    
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/reset-password-request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, captchaToken }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.body.removeChild(modal);
        // 다음 단계: 코드 입력 모달
        showResetCodeModal(email);
      } else {
        errorMsg.textContent = data.error || 'Failed to send reset code';
        errorMsg.classList.add('show');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Reset Code';
        if (resetTurnstileId) turnstile.reset(resetTurnstileId);
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send Reset Code';
      if (resetTurnstileId) turnstile.reset(resetTurnstileId);
    }
  };
  
  cancelBtn.onclick = () => document.body.removeChild(modal);
}

// 리셋 코드 확인 모달
function showResetCodeModal(email) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  
  box.innerHTML = `
    <h2>📬 Enter Reset Code</h2>
    <p style="margin-bottom: 16px;">A 6-digit code has been sent to <strong>${email}</strong></p>
    <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Check your email (including spam folder)</p>
    <input type="text" id="reset-code" placeholder="123456" maxlength="6" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; text-align: center; font-size: 18px; letter-spacing: 4px; font-family: monospace;" />
    <input type="password" id="new-password" placeholder="New Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;" />
    <div id="reset-password-strength" style="margin-bottom: 8px; font-size: 12px; display: none;"></div>
    <div id="reset-password-requirements" style="margin-bottom: 12px; font-size: 12px; color: #6b7280; display: none;">
      <p style="font-weight: 600; margin-bottom: 4px;">Password must contain:</p>
      <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li id="reset-req-length">At least 8 characters</li>
        <li id="reset-req-upper">One uppercase letter (A-Z)</li>
        <li id="reset-req-lower">One lowercase letter (a-z)</li>
        <li id="reset-req-number">One number (0-9)</li>
        <li id="reset-req-special">One special character (!@#$%...)</li>
      </ul>
    </div>
    <input type="password" id="confirm-new-password" placeholder="Confirm New Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
    <div class="error-message" id="code-error"></div>
    <button id="confirm-reset" style="background: #8b5cf6; margin-top: 12px;">Reset Password</button>
    <button id="resend-code" style="background: #3b82f6; margin-top: 12px;">Resend Code</button>
    <button id="cancel-code" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  const codeInput = box.querySelector('#reset-code');
  const newPasswordInput = box.querySelector('#new-password');
  const confirmPasswordInput = box.querySelector('#confirm-new-password');
  const confirmBtn = box.querySelector('#confirm-reset');
  const resendBtn = box.querySelector('#resend-code');
  const cancelBtn = box.querySelector('#cancel-code');
  const errorMsg = box.querySelector('#code-error');
  const strengthDiv = box.querySelector('#reset-password-strength');
  const requirementsDiv = box.querySelector('#reset-password-requirements');
  
  // 숫자만 입력 가능
  codeInput.oninput = () => {
    codeInput.value = codeInput.value.replace(/[^0-9]/g, '');
  };
  
  // 비밀번호 입력 시 실시간 강도 표시
  newPasswordInput.oninput = () => {
    const password = newPasswordInput.value;
    
    if (password.length > 0) {
      strengthDiv.style.display = 'block';
      requirementsDiv.style.display = 'block';
      
      const strength = getPasswordStrength(password);
      strengthDiv.innerHTML = `Password Strength: <strong style="color: ${strength.color};">${strength.text}</strong>`;
      
      const reqLength = box.querySelector('#reset-req-length');
      const reqUpper = box.querySelector('#reset-req-upper');
      const reqLower = box.querySelector('#reset-req-lower');
      const reqNumber = box.querySelector('#reset-req-number');
      const reqSpecial = box.querySelector('#reset-req-special');
      
      reqLength.style.color = password.length >= 8 ? '#10b981' : '#6b7280';
      reqLength.innerHTML = password.length >= 8 ? '✅ At least 8 characters' : 'At least 8 characters';
      
      reqUpper.style.color = /[A-Z]/.test(password) ? '#10b981' : '#6b7280';
      reqUpper.innerHTML = /[A-Z]/.test(password) ? '✅ One uppercase letter (A-Z)' : 'One uppercase letter (A-Z)';
      
      reqLower.style.color = /[a-z]/.test(password) ? '#10b981' : '#6b7280';
      reqLower.innerHTML = /[a-z]/.test(password) ? '✅ One lowercase letter (a-z)' : 'One lowercase letter (a-z)';
      
      reqNumber.style.color = /[0-9]/.test(password) ? '#10b981' : '#6b7280';
      reqNumber.innerHTML = /[0-9]/.test(password) ? '✅ One number (0-9)' : 'One number (0-9)';
      
      reqSpecial.style.color = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password) ? '#10b981' : '#6b7280';
      reqSpecial.innerHTML = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password) ? '✅ One special character (!@#$%...)' : 'One special character (!@#$%...)';
    } else {
      strengthDiv.style.display = 'none';
      requirementsDiv.style.display = 'none';
    }
  };
  
  confirmBtn.onclick = async () => {
    const code = codeInput.value.trim();
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (!code || code.length !== 6) {
      errorMsg.textContent = 'Please enter the 6-digit code';
      errorMsg.classList.add('show');
      return;
    }
    
    // 비밀번호 유효성 검사
    const validation = validatePassword(newPassword);
    if (!validation.isValid) {
      errorMsg.innerHTML = '<strong>Password requirements not met:</strong><br>' + validation.errors.join('<br>');
      errorMsg.classList.add('show');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      errorMsg.textContent = 'Passwords do not match';
      errorMsg.classList.add('show');
      return;
    }
    
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Resetting...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/reset-password-confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, resetCode: code, newPassword }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.body.removeChild(modal);
        showModal('✅ Password Reset', '<p>Your password has been successfully reset.</p><p>Please login with your new password.</p>');
      } else {
        errorMsg.textContent = data.error || 'Invalid or expired code';
        errorMsg.classList.add('show');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Reset Password';
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Reset Password';
    }
  };
  
  resendBtn.onclick = () => {
    document.body.removeChild(modal);
    handleForgotPassword();
  };
  
  cancelBtn.onclick = () => document.body.removeChild(modal);
}

// 비밀번호 변경 처리
async function handleChangePassword() {
  if (!currentUser) {
    showModal('❌ Error', '<p>No user logged in</p>');
    return;
  }

  // 이메일 계정만 비밀번호 변경 가능
  if (currentUser.provider !== 'email') {
    showModal('⚠️ Not Available', '<p>Password change is only available for email accounts.</p><p>OAuth accounts (Google, GitHub) use their provider\'s security.</p>');
    return;
  }

  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  
  box.innerHTML = `
    <h2>🔑 Change Password</h2>
    <p style="margin-bottom: 16px;">Enter your current password and new password.</p>
    <input type="password" id="current-password" placeholder="Current Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
    <input type="password" id="new-password" placeholder="New Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;" />
    <div id="change-password-strength" style="margin-bottom: 8px; font-size: 12px; display: none;"></div>
    <div id="change-password-requirements" style="margin-bottom: 12px; font-size: 12px; color: #6b7280; display: none;">
      <p style="font-weight: 600; margin-bottom: 4px;">Password must contain:</p>
      <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li id="change-req-length">At least 8 characters</li>
        <li id="change-req-upper">One uppercase letter (A-Z)</li>
        <li id="change-req-lower">One lowercase letter (a-z)</li>
        <li id="change-req-number">One number (0-9)</li>
        <li id="change-req-special">One special character (!@#$%...)</li>
      </ul>
    </div>
    <input type="password" id="confirm-password" placeholder="Confirm New Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
    <div class="captcha-container" id="change-password-captcha-container">
      <div id="change-password-turnstile-widget"></div>
    </div>
    <div class="error-message" id="change-password-error"></div>
    <button id="confirm-change-password" style="background: #3b82f6; margin-top: 12px;">Change Password</button>
    <button id="cancel-change-password" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  let changePwTurnstileId;
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      changePwTurnstileId = turnstile.render('#change-password-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      });
    }
  }, 100);
  
  const currentPasswordInput = box.querySelector('#current-password');
  const newPasswordInput = box.querySelector('#new-password');
  const confirmPasswordInput = box.querySelector('#confirm-password');
  const confirmBtn = box.querySelector('#confirm-change-password');
  const cancelBtn = box.querySelector('#cancel-change-password');
  const errorMsg = box.querySelector('#change-password-error');
  const strengthDiv = box.querySelector('#change-password-strength');
  const requirementsDiv = box.querySelector('#change-password-requirements');
  
  // 비밀번호 입력 시 실시간 강도 표시
  newPasswordInput.oninput = () => {
    const password = newPasswordInput.value;
    
    if (password.length > 0) {
      strengthDiv.style.display = 'block';
      requirementsDiv.style.display = 'block';
      
      const strength = getPasswordStrength(password);
      strengthDiv.innerHTML = `Password Strength: <strong style="color: ${strength.color};">${strength.text}</strong>`;
      
      const reqLength = box.querySelector('#change-req-length');
      const reqUpper = box.querySelector('#change-req-upper');
      const reqLower = box.querySelector('#change-req-lower');
      const reqNumber = box.querySelector('#change-req-number');
      const reqSpecial = box.querySelector('#change-req-special');
      
      reqLength.style.color = password.length >= 8 ? '#10b981' : '#6b7280';
      reqLength.innerHTML = password.length >= 8 ? '✅ At least 8 characters' : 'At least 8 characters';
      
      reqUpper.style.color = /[A-Z]/.test(password) ? '#10b981' : '#6b7280';
      reqUpper.innerHTML = /[A-Z]/.test(password) ? '✅ One uppercase letter (A-Z)' : 'One uppercase letter (A-Z)';
      
      reqLower.style.color = /[a-z]/.test(password) ? '#10b981' : '#6b7280';
      reqLower.innerHTML = /[a-z]/.test(password) ? '✅ One lowercase letter (a-z)' : 'One lowercase letter (a-z)';
      
      reqNumber.style.color = /[0-9]/.test(password) ? '#10b981' : '#6b7280';
      reqNumber.innerHTML = /[0-9]/.test(password) ? '✅ One number (0-9)' : 'One number (0-9)';
      
      reqSpecial.style.color = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/''`;~`]/.test(password) ? '#10b981' : '#6b7280';
      reqSpecial.innerHTML = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\\/''`;~`]/.test(password) ? '✅ One special character (!@#$%...)' : 'One special character (!@#$%...)';
    } else {
      strengthDiv.style.display = 'none';
      requirementsDiv.style.display = 'none';
    }
  };
  
  confirmBtn.onclick = async () => {
    const currentPassword = currentPasswordInput.value;
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      errorMsg.textContent = 'All fields are required';
      errorMsg.classList.add('show');
      return;
    }
    
    // 비밀번호 유효성 검사
    const validation = validatePassword(newPassword);
    if (!validation.isValid) {
      errorMsg.innerHTML = '<strong>Password requirements not met:</strong><br>' + validation.errors.join('<br>');
      errorMsg.classList.add('show');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      errorMsg.textContent = 'New passwords do not match';
      errorMsg.classList.add('show');
      return;
    }
    
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(changePwTurnstileId);
      if (!captchaToken) {
        errorMsg.textContent = 'Please complete the captcha';
        errorMsg.classList.add('show');
        return;
      }
    } catch (e) {
      errorMsg.textContent = 'Captcha error. Please refresh the page.';
      errorMsg.classList.add('show');
      return;
    }
    
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Changing...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/change-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          email: currentUser.email,
          currentPassword: currentPassword,
          newPassword: newPassword,
          captchaToken: captchaToken
        }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.body.removeChild(modal);
        showModal('✅ Password Changed', '<p>Your password has been successfully changed.</p>');
      } else {
        errorMsg.textContent = data.error || 'Password change failed';
        errorMsg.classList.add('show');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Change Password';
        if (changePwTurnstileId) turnstile.reset(changePwTurnstileId);
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Change Password';
      if (changePwTurnstileId) turnstile.reset(changePwTurnstileId);
    }
  };
  
  cancelBtn.onclick = () => document.body.removeChild(modal);
}

// 🔥 회원탈퇴 처리 - 2단계 인증 방식
async function handleDeleteAccount() {
  if (!currentUser) {
    showModal('❌ Error', '<p>No user logged in</p>');
    return;
  }

  // 1단계: 비밀번호 확인 & 인증 코드 요청
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  
  if (currentUser.provider === 'email') {
    // 이메일 계정은 비밀번호 확인 필요
    box.innerHTML = `
      <h2>⚠️ Delete Account - Step 1</h2>
      <p style="color: #dc2626; font-weight: 600; margin-bottom: 16px;">⚠️ This action cannot be undone!</p>
      <p style="margin-bottom: 16px;">Enter your password to receive a verification code.</p>
      <input type="password" id="delete-password" placeholder="Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
      <div class="captcha-container" id="delete-captcha-container">
        <div id="delete-turnstile-widget"></div>
      </div>
      <div class="error-message" id="delete-error"></div>
      <button id="send-delete-code" style="background: #dc2626; margin-top: 12px;">Send Verification Code</button>
      <button id="cancel-delete" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
    `;
  } else {
    // OAuth 계정은 비밀번호 없이 진행
    box.innerHTML = `
      <h2>⚠️ Delete Account - Step 1</h2>
      <p style="color: #dc2626; font-weight: 600; margin-bottom: 16px;">⚠️ This action cannot be undone!</p>
      <p style="margin-bottom: 16px;">Click below to receive a verification code at <strong>${currentUser.email}</strong></p>
      <div class="captcha-container" id="delete-captcha-container">
        <div id="delete-turnstile-widget"></div>
      </div>
      <div class="error-message" id="delete-error"></div>
      <button id="send-delete-code" style="background: #dc2626; margin-top: 12px;">Send Verification Code</button>
      <button id="cancel-delete" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
    `;
  }
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  let deleteTurnstileId;
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      deleteTurnstileId = turnstile.render('#delete-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      });
    }
  }, 100);
  
  const sendBtn = box.querySelector('#send-delete-code');
  const cancelBtn = box.querySelector('#cancel-delete');
  const errorMsg = box.querySelector('#delete-error');
  
  sendBtn.onclick = async () => {
    let password = null;
    if (currentUser.provider === 'email') {
      password = box.querySelector('#delete-password').value;
      if (!password) {
        errorMsg.textContent = 'Password required';
        errorMsg.classList.add('show');
        return;
      }
    }
    
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(deleteTurnstileId);
      if (!captchaToken) {
        errorMsg.textContent = 'Please complete the captcha';
        errorMsg.classList.add('show');
        return;
      }
    } catch (e) {
      errorMsg.textContent = 'Captcha error. Please refresh the page.';
      errorMsg.classList.add('show');
      return;
    }
    
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/delete-account-request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          email: currentUser.email,
          password: password,
          captchaToken: captchaToken
        }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.body.removeChild(modal);
        // 2단계: 인증 코드 입력 모달
        showDeleteCodeModal(currentUser.email);
      } else {
        errorMsg.textContent = data.error || 'Failed to send verification code';
        errorMsg.classList.add('show');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Verification Code';
        if (deleteTurnstileId) turnstile.reset(deleteTurnstileId);
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send Verification Code';
      if (deleteTurnstileId) turnstile.reset(deleteTurnstileId);
    }
  };
  
  cancelBtn.onclick = () => document.body.removeChild(modal);
}

// 2단계: 회원탈퇴 인증 코드 확인 모달
function showDeleteCodeModal(email) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  
  box.innerHTML = `
    <h2>⚠️ Delete Account - Step 2</h2>
    <p style="margin-bottom: 16px;">A 6-digit code has been sent to <strong>${email}</strong></p>
    <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Check your email (including spam folder)</p>
    <input type="text" id="delete-code" placeholder="123456" maxlength="6" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; text-align: center; font-size: 18px; letter-spacing: 4px; font-family: monospace;" />
    <div class="error-message" id="code-error"></div>
    <button id="confirm-delete" style="background: #dc2626; margin-top: 12px;">⚠️ DELETE ACCOUNT</button>
    <button id="resend-delete-code" style="background: #3b82f6; margin-top: 12px;">Resend Code</button>
    <button id="cancel-code" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  const codeInput = box.querySelector('#delete-code');
  const confirmBtn = box.querySelector('#confirm-delete');
  const resendBtn = box.querySelector('#resend-delete-code');
  const cancelBtn = box.querySelector('#cancel-code');
  const errorMsg = box.querySelector('#code-error');
  
  // 숫자만 입력 가능
  codeInput.oninput = () => {
    codeInput.value = codeInput.value.replace(/[^0-9]/g, '');
  };
  
  confirmBtn.onclick = async () => {
    const code = codeInput.value.trim();
    
    if (!code || code.length !== 6) {
      errorMsg.textContent = 'Please enter the 6-digit code';
      errorMsg.classList.add('show');
      return;
    }
    
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Deleting...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/delete-account-confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        // 로그아웃 처리
        currentUser = null;
        isPro = false;
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isPro');
        updateAccountButton();
        
        const promoBar = document.querySelector('.promo-bar');
        if (promoBar) promoBar.classList.remove('hidden');
        const crownBtn = document.getElementById('crown-button');
        if (crownBtn) crownBtn.classList.remove('pro');
        document.body.classList.remove('pro-active');
        document.getElementById('wrapper').classList.remove('pro-active');
        
        document.body.removeChild(modal);
        showModal('✅ Account Deleted', '<p>Your account has been permanently deleted.</p>');
      } else {
        errorMsg.textContent = data.error || 'Invalid or expired code';
        errorMsg.classList.add('show');
        confirmBtn.disabled = false;
        confirmBtn.textContent = '⚠️ DELETE ACCOUNT';
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      confirmBtn.disabled = false;
      confirmBtn.textContent = '⚠️ DELETE ACCOUNT';
    }
  };
  
  resendBtn.onclick = () => {
    document.body.removeChild(modal);
    handleDeleteAccount();
  };
  
  cancelBtn.onclick = () => document.body.removeChild(modal);
}

// 이메일 로그인 처리
async function handleEmailLogin() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>📧 Email Login</h2>
    <p style="margin-bottom: 16px;">Enter your email to sign in</p>
    <input type="email" id="email-input" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;" />
    <input type="password" id="password-input" placeholder="Password" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;" />
    <div id="password-strength" style="margin-bottom: 8px; font-size: 12px; display: none;"></div>
    <div id="password-requirements" style="margin-bottom: 12px; font-size: 12px; color: #6b7280; display: none;">
      <p style="font-weight: 600; margin-bottom: 4px;">Password must contain:</p>
      <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
        <li id="req-length">At least 8 characters</li>
        <li id="req-upper">One uppercase letter (A-Z)</li>
        <li id="req-lower">One lowercase letter (a-z)</li>
        <li id="req-number">One number (0-9)</li>
        <li id="req-special">One special character (!@#$%...)</li>
      </ul>
    </div>
    <p style="text-align: right; margin-bottom: 12px;"><a href="#" id="forgot-password-link" style="color: #8b5cf6; font-size: 13px; text-decoration: none;">Forgot password?</a></p>
    <div class="captcha-container" id="email-captcha-container">
      <div id="email-turnstile-widget"></div>
    </div>
    <div class="error-message" id="email-login-error"></div>
    <button id="email-login-submit" style="margin-top: 12px;">Sign In</button>
    <button id="close-email-login" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  let emailTurnstileId;
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      emailTurnstileId = turnstile.render('#email-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      });
    }
  }, 100);
  
  const emailInput = box.querySelector('#email-input');
  const passwordInput = box.querySelector('#password-input');
  const submitBtn = box.querySelector('#email-login-submit');
  const errorMsg = box.querySelector('#email-login-error');
  const forgotLink = box.querySelector('#forgot-password-link');
  const strengthDiv = box.querySelector('#password-strength');
  const requirementsDiv = box.querySelector('#password-requirements');
  
  // 비밀번호 입력 시 실시간 강도 표시 및 조건 체크
  passwordInput.oninput = () => {
    const password = passwordInput.value;
    
    if (password.length > 0) {
      strengthDiv.style.display = 'block';
      requirementsDiv.style.display = 'block';
      
      // 강도 표시
      const strength = getPasswordStrength(password);
      strengthDiv.innerHTML = `Password Strength: <strong style="color: ${strength.color};">${strength.text}</strong>`;
      
      // 조건 체크
      const reqLength = box.querySelector('#req-length');
      const reqUpper = box.querySelector('#req-upper');
      const reqLower = box.querySelector('#req-lower');
      const reqNumber = box.querySelector('#req-number');
      const reqSpecial = box.querySelector('#req-special');
      
      reqLength.style.color = password.length >= 8 ? '#10b981' : '#6b7280';
      reqLength.innerHTML = password.length >= 8 ? '✅ At least 8 characters' : 'At least 8 characters';
      
      reqUpper.style.color = /[A-Z]/.test(password) ? '#10b981' : '#6b7280';
      reqUpper.innerHTML = /[A-Z]/.test(password) ? '✅ One uppercase letter (A-Z)' : 'One uppercase letter (A-Z)';
      
      reqLower.style.color = /[a-z]/.test(password) ? '#10b981' : '#6b7280';
      reqLower.innerHTML = /[a-z]/.test(password) ? '✅ One lowercase letter (a-z)' : 'One lowercase letter (a-z)';
      
      reqNumber.style.color = /[0-9]/.test(password) ? '#10b981' : '#6b7280';
      reqNumber.innerHTML = /[0-9]/.test(password) ? '✅ One number (0-9)' : 'One number (0-9)';
      
      reqSpecial.style.color = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password) ? '#10b981' : '#6b7280';
      reqSpecial.innerHTML = /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\/'';~`]/.test(password) ? '✅ One special character (!@#$%...)' : 'One special character (!@#$%...)';
    } else {
      strengthDiv.style.display = 'none';
      requirementsDiv.style.display = 'none';
    }
  };
  
  forgotLink.onclick = (e) => {
    e.preventDefault();
    document.body.removeChild(modal);
    handleForgotPassword();
  };
  
  submitBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    
    if (!email || !password) {
      errorMsg.textContent = 'Please enter both email and password';
      errorMsg.classList.add('show');
      return;
    }
    
    // 비밀번호 유효성 검사 (회원가입 시에만 적용)
    const validation = validatePassword(password);
    if (!validation.isValid) {
      errorMsg.innerHTML = '<strong>Password requirements not met:</strong><br>' + validation.errors.join('<br>');
      errorMsg.classList.add('show');
      return;
    }
    
    // 캡챠 확인
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(emailTurnstileId);
      if (!captchaToken) {
        errorMsg.textContent = 'Please complete the captcha';
        errorMsg.classList.add('show');
        return;
      }
    } catch (e) {
      errorMsg.textContent = 'Captcha error. Please refresh the page.';
      errorMsg.classList.add('show');
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing in...';
    
    try {
      const response = await fetch(`${AUTH_API_URL}/email-login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, captchaToken }),
      });
      
      const data = await response.json();
      
      if (data.success) {
        currentUser = data.user;
        isPro = data.user.isPro || false;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        if (isPro) {
          localStorage.setItem('isPro', 'true');
          const promoBar = document.querySelector('.promo-bar');
          if (promoBar) promoBar.classList.add('hidden');
          const crownBtn = document.getElementById('crown-button');
          if (crownBtn) crownBtn.classList.add('pro');
          document.body.classList.add('pro-active');
          document.getElementById('wrapper').classList.add('pro-active');
        }
        updateAccountButton();
        document.body.removeChild(modal);
      } else {
        errorMsg.textContent = data.error || 'Login failed';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
        if (emailTurnstileId) turnstile.reset(emailTurnstileId);
      }
    } catch (error) {
      errorMsg.textContent = 'Network error. Please try again.';
      errorMsg.classList.add('show');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign In';
      if (emailTurnstileId) turnstile.reset(emailTurnstileId);
    }
  };
  
  box.querySelector('#close-email-login').onclick = () => document.body.removeChild(modal);
}

// OAuth 로그인 처리
async function handleOAuthLogin(provider) {
  try {
    // 1. 백엔드에서 OAuth URL 가져오기
    const response = await fetch(`${AUTH_API_URL}/oauth/${provider}`, {
      method: 'GET',
    });
    
    if (!response.ok) {
      throw new Error('Failed to get OAuth URL');
    }
    
    const data = await response.json();
    
    if (data.authUrl) {
      // 2. OAuth 팝업 창 열기
      const width = 500;
      const height = 600;
      const left = (screen.width / 2) - (width / 2);
      const top = (screen.height / 2) - (height / 2);
      
      const popup = window.open(
        data.authUrl,
        'oauth',
        `width=${width},height=${height},left=${left},top=${top}`
      );
      
      // 3. 팝업에서 메시지 대기
      window.addEventListener('message', function handleOAuthMessage(event) {
        // 보안: origin 확인
        if (event.origin !== window.location.origin) return;
        
        if (event.data.type === 'oauth-success') {
          currentUser = event.data.user;
          isPro = event.data.user.isPro || false;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          if (isPro) {
            localStorage.setItem('isPro', 'true');
            const promoBar = document.querySelector('.promo-bar');
            if (promoBar) promoBar.classList.add('hidden');
            const crownBtn = document.getElementById('crown-button');
            if (crownBtn) crownBtn.classList.add('pro');
            document.body.classList.add('pro-active');
            document.getElementById('wrapper').classList.add('pro-active');
          }
          updateAccountButton();
          window.removeEventListener('message', handleOAuthMessage);
          if (popup) popup.close();
        } else if (event.data.type === 'oauth-error') {
          showModal('❌ Error', `<p>Authentication failed: ${event.data.error}</p>`);
          window.removeEventListener('message', handleOAuthMessage);
          if (popup) popup.close();
        }
      });
    }
  } catch (error) {
    console.error('OAuth login error:', error);
    showModal('❌ Error', `<p>Failed to initiate login: ${error.message}</p>`);
  }
}

// 옥관 버튼 클릭 (PRO 구매)
crownButton.onclick = () => {
  if (isPro) {
    showModal('✨ Already PRO', `
      <p>You are already a PRO user!</p>
      <p>All premium features are unlocked.</p>
    `);
    return;
  }
  
  // PRO 활성화하려면 로그인 필요
  if (!currentUser) {
    showModal('🔒 Login Required', `
      <p>You need to sign in to activate PRO.</p>
      <p>PRO status will be synced across all your devices.</p>
    `, () => accountButton.click());
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>🌟 Upgrade to RandomSeats PRO</h2>
    <p style="margin-bottom: 16px;">Unlock premium features:</p>
    <ul style="margin: 16px 0; line-height: 1.8;">
      <li>✅ <strong>JSON Import/Export</strong> - Save and load seating arrangements</li>
      <li>✅ <strong>Teacher View</strong> - 180° rotation for instructor's perspective</li>
      <li>✅ <strong>Ad-Free Experience</strong> - Remove all promotional content</li>
      <li>✅ <strong>Future Updates</strong> - Access to upcoming PRO features</li>
    </ul>
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enter PRO License Key</label>
      <input type="text" id="pro-key-input" placeholder="XXXXX-XXXXX-XXXXX-XXXXX-XXXXX" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: monospace;" />
      <div class="error-message" id="pro-key-error"></div>
      <div class="captcha-container" id="pro-captcha-container">
        <div id="pro-turnstile-widget"></div>
      </div>
      <button id="activate-pro-button" style="margin-top: 12px;">Activate PRO</button>
    </div>
    <button id="close-pro-modal" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      turnstileWidgetId = turnstile.render('#pro-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
      });
    }
  }, 100);


  const proKeyInput = document.querySelector('#pro-key-input');
  const activateButton = box.querySelector('#activate-pro-button');
  const keyError = box.querySelector('#pro-key-error');
  
activateButton.onclick = async (e) => {
  e.preventDefault(); // 🚀 form의 기본 동작(새로고침 + GET요청) 막기

  
    
    const key = proKeyInput.value.trim();
    
    if (!key) {
      keyError.textContent = 'Please enter a PRO license key';
      keyError.classList.add('show');
      return;
    }
    
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(turnstileWidgetId);
      if (!captchaToken) {
        keyError.textContent = 'Please complete the captcha';
        keyError.classList.add('show');
        return;
      }
    } catch (e) {
      keyError.textContent = 'Captcha error. Please refresh the page.';
      keyError.classList.add('show');
      return;
    }
    
    activateButton.disabled = true;
    activateButton.textContent = 'Verifying...';
    keyError.classList.remove('show');
    
    try {
      const response = await fetch(WORKER_API_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ key, captchaToken }),
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        // PRO 상태를 서버에 저장
        await fetch(`${AUTH_API_URL}/set-pro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: currentUser.email, 
            isPro: true 
          }),
        });
        
        localStorage.setItem('isPro', 'true');
        isPro = true;
        currentUser.isPro = true;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        const promoBar = document.querySelector('.promo-bar');
        if (promoBar) promoBar.classList.add('hidden');
        
        crownButton.classList.add('pro');
        document.body.classList.add('pro-active');
        document.getElementById('wrapper').classList.add('pro-active');
        
        document.body.removeChild(modal);
        showModal('🎉 Welcome to PRO', `
          <p>Welcome to RandomSeats PRO!</p>
          <p>All premium features are now unlocked across all your devices.</p>
        `);
      } else {
        keyError.textContent = result.error || 'Invalid PRO key';
        keyError.classList.add('show');
        activateButton.disabled = false;
        activateButton.textContent = 'Activate PRO';
        turnstile.reset(turnstileWidgetId);
      }
    } catch (error) {
      console.error('Activation error:', error);
      
      // 서버 응답이 있으면 자세히 표시
      if (error.message.includes('HTTP')) {
        keyError.textContent = `Server Error: ${error.message}. Check Cloudflare Workers logs for details.`;
      } else {
        keyError.textContent = `Error: ${error.message}`;
      }
      keyError.classList.add('show');
      activateButton.disabled = false;
      activateButton.textContent = 'Activate PRO';
      if (turnstileWidgetId) turnstile.reset(turnstileWidgetId);
    }
  };
  
  box.querySelector('#close-pro-modal').onclick = () => document.body.removeChild(modal);
};

// JSON 업로드 (PRO 전용)
uploadButton.onclick = () => {
  if (!isPro) {
    showModal('🌟 PRO Feature', `
      <p>JSON Import/Export is a PRO feature.</p>
      <p>Would you like to upgrade to PRO?</p>
    `, () => crownButton.click());
    return;
  }
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        currentSeatAssignment = JSON.parse(ev.target.result);
        renderSeatsWithAssignment();
      } catch {
        alert("Invalid JSON file format.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

startButton.onclick = () => assignSeats();
resetButton.onclick = () => renderEmptySeats();

// 범용 모달 함수
function showModal(title, content, onConfirm = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>${title}</h2>
    ${content}
    ${onConfirm ? '<button id="modal-confirm">Confirm</button>' : ''}
    <button id="modal-close" style="${onConfirm ? 'background: #e2e8f0; color: #4a5568;' : ''}">Close</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  const closeBtn = box.querySelector('#modal-close');
  closeBtn.onclick = () => document.body.removeChild(modal);
  
  if (onConfirm) {
    const confirmBtn = box.querySelector('#modal-confirm');
    confirmBtn.onclick = () => {
      document.body.removeChild(modal);
      onConfirm();
    };
  }
  
  modal.onclick = (e) => {
    if (e.target === modal) document.body.removeChild(modal);
  };
}

// 커피 모달
function showCoffeeModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>☕ Buy Me a Coffee</h2>
    <p>Support the developer to create better projects!</p>
    <p style="margin-top: 16px;">🎁 <strong>QR code coming soon!</strong></p>
    <button id="close-coffee">Close</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  box.querySelector('#close-coffee').onclick = () => document.body.removeChild(modal);
}

// 피드백 모달
function showFeedbackModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>💌 Feedback & Rating</h2>
    <p style="margin-bottom: 16px;">How do you like RandomSeats?</p>
    <div style="text-align: center; margin: 24px 0; font-size: 32px;">
      <span class="star" data-rating="1">⭐</span>
      <span class="star" data-rating="2">⭐</span>
      <span class="star" data-rating="3">⭐</span>
      <span class="star" data-rating="4">⭐</span>
      <span class="star" data-rating="5">⭐</span>
    </div>
    <textarea id="feedback-text" placeholder="Leave your feedback (optional)" style="width: 100%; min-height: 100px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; font-family: inherit;"></textarea>
    <button id="submit-feedback" style="margin-top: 12px;">Submit</button>
    <button id="close-feedback" style="background: #e2e8f0; color: #4a5568;">Close</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  let selectedRating = 0;
  box.querySelectorAll('.star').forEach(star => {
    star.style.cursor = 'pointer';
    star.style.opacity = '0.3';
    star.style.transition = 'opacity 0.2s';
    star.onclick = () => {
      selectedRating = parseInt(star.dataset.rating);
      box.querySelectorAll('.star').forEach((s, i) => {
        s.style.opacity = i < selectedRating ? '1' : '0.3';
      });
    };
  });
  
  box.querySelector('#submit-feedback').onclick = () => {
    if (selectedRating === 0) {
      showModal('⚠️ Rating Required', '<p>Please select a rating before submitting!</p>');
      return;
    }
    const feedbackText = box.querySelector('#feedback-text').value;
    document.body.removeChild(modal);
    showModal(`✨ Thank you!`, `<p>Thank you for your ${selectedRating}⭐ rating${feedbackText ? ' and feedback' : ''}!</p>`);
  };
  
  box.querySelector('#close-feedback').onclick = () => document.body.removeChild(modal);
}

photoButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Export Options</h2>
  <button id="save-png">Export as PNG</button>
  <button id="save-json" ${!isPro ? 'disabled title="PRO feature"' : ''}>Export as JSON ${!isPro ? '👑' : ''}</button>
  <button id="close-save">Cancel</button>
  `;

  box.querySelector('#save-png').onclick = () => {
    if (!currentSeatAssignment) {
      alert("No seat arrangement. Please assign seats first.");
      document.body.removeChild(modal);
      return;
    }

    // 임시 컨테이너 생성
    const tempContainer = createTempContainer();
    
    // html2canvas로 캡처
    html2canvas(tempContainer, {
      backgroundColor: 'white',
      scale: 2,
      useCORS: true,
      allowTaint: false,
      foreignObjectRendering: false,
      logging: false,
      width: tempContainer.scrollWidth,
      height: tempContainer.scrollHeight
    }).then(canvas => {
      // 저작권 표시 추가
      const ctx = canvas.getContext('2d');
      ctx.font = '14px Inter, Arial';
      ctx.fillStyle = '#999';
      ctx.textAlign = 'right';
      ctx.fillText('© 2025 Eunsung Lee', canvas.width - 20, canvas.height - 15);
      // 임시 컨테이너 제거
      document.body.removeChild(tempContainer);
      
      // 다운로드 링크 생성
      const link = document.createElement('a');
      link.download = `seat_arrangement_${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      document.body.removeChild(modal);
    }).catch(error => {
      // 오류 시 임시 컨테이너 정리
      if (document.body.contains(tempContainer)) {
        document.body.removeChild(tempContainer);
      }
      console.error('이미지 저장 오류:', error);
      alert('An error occurred while saving the image. Please refresh and try again.');
      document.body.removeChild(modal);
    });
  };

  box.querySelector('#save-json').onclick = () => {
    if (!isPro) {
      alert('🌟 JSON Export is a PRO feature. Please upgrade to RandomSeats PRO.');
      document.body.removeChild(modal);
      crownButton.click();
      return;
    }
    if (!currentSeatAssignment) {
      alert("No seat arrangement to export.");
      document.body.removeChild(modal);
      return;
    }
    const blob = new Blob([JSON.stringify(currentSeatAssignment, null, 2)], {type: "application/json"});
    const link = document.createElement('a');
    link.download = `seat_arrangement_${new Date().toISOString().slice(0,10)}.json`;
    link.href = URL.createObjectURL(blob);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href); // 메모리 정리
    document.body.removeChild(modal);
  };

  box.querySelector('#close-save').onclick = () => document.body.removeChild(modal);
  modal.appendChild(box);
  document.body.appendChild(modal);
};

settingsButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Settings</h2>
  <label><input type="checkbox" id="desk-toggle" ${deskVisible ? 'checked' : ''}> Show Teacher Desk</label>
  <label><input type="checkbox" id="teacher-view-toggle" ${teacherView ? 'checked' : ''} ${!isPro ? 'disabled' : ''}> Teacher View (Rotate 180°) ${!isPro ? '<span style="color: #f59e0b; font-size: 12px;">👑 PRO</span>' : ''}</label>

  <button id="close-settings">Close</button>
`;


  const deskToggle = box.querySelector('#desk-toggle');
  const teacherViewToggle = box.querySelector('#teacher-view-toggle');

  deskToggle.onchange = () => {
    deskVisible = deskToggle.checked;
    if (currentSeatAssignment) {
      renderSeatsWithAssignment();
    } else {
      renderEmptySeats();
    }
  };

  teacherViewToggle.onchange = () => {
    if (!isPro) {
      teacherViewToggle.checked = false;
      showModal('🌟 PRO Feature', `
        <p>Teacher View is a PRO feature.</p>
        <p>Would you like to upgrade to PRO?</p>
      `, () => crownButton.click());
      return;
    }
    teacherView = teacherViewToggle.checked;
    if (teacherView) {
      wrapper.classList.add('teacher-view');
    } else {
      wrapper.classList.remove('teacher-view');
    }
  };

  box.querySelector('#close-settings').onclick = () => document.body.removeChild(modal);

  modal.appendChild(box);
  document.body.appendChild(modal);
};

infoButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Seat Arrangement System v2.8.1</h2>
  <p><strong>Created by:</strong> Eunsung Lee</p>
  <p>A smart and intuitive tool for managing classroom seating arrangements.</p>
  <p><strong>Key Features:</strong></p>
  <ul>
    <li>Automatic random assignment by gender</li>
    <li>Simple drag & drop seat swapping</li>
    <li>Teacher View (180° rotation for instructor’s perspective)</li>
    <li>Export and Import as high-resolution PNG or JSON</li>
    <li>Responsive design for desktop and mobile</li>
  </ul>
  <p><strong>Latest Update:</strong> Teacher View export support, improved UI/UX</p>
  <p><strong>License:</strong> CC BY-NC-ND 4.0</p>
  <p>Free for educational and non-commercial use. For commercial use, please contact the author.</p>
  <button id="close-info">Close</button>
`;


  box.querySelector('#close-info').onclick = () => document.body.removeChild(modal);

  modal.appendChild(box);
  document.body.appendChild(modal);
};

renderEmptySeats();
</script>


</body>
</html>
