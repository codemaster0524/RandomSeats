<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RandomSeats</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
/* 회전 대응 wrapper */
.seat-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
}
.seat-wrapper.rotate-left {
  transform: rotate(90deg);
}
.seat-wrapper.rotate-right {
  transform: rotate(-90deg);
}

    html, body {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }
    
    #wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
    }

    /* 쌤 뷰 적용 시 좌석 컨테이너만 회전 */
    #wrapper.teacher-view #seat-container {
      transform: rotate(180deg);
    }

    /* 쌤 뷰 적용 시 텍스트는 다시 정상 방향으로 회전 */
    #wrapper.teacher-view .seat,
    #wrapper.teacher-view .desk {
      transform: rotate(180deg);
    }

    /* 다이나믹 아일랜드는 항상 정상 방향 유지 */
    #wrapper.teacher-view #dynamic-island {
      transform: none;
    }
    
    #dynamic-island {
      background: rgba(20, 20, 20, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      animation: fadeInUp 0.6s ease-out;
    }
    
    .button {
      width: 44px;
      height: 44px;
      background: rgba(60, 60, 60, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      color: #ffffff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .button:hover {
      background: rgba(80, 80, 80, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .button:hover::before {
      left: 100%;
    }
    
    .button:active {
      transform: translateY(0);
    }
    
    /* 왕관 버튼 (PRO) */
    .button.crown {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border: 2px solid #fbbf24;
    }
    
    .button.crown.pro {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .button.crown:hover {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }
    
    .button.crown.pro:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    #seat-container {
    display: grid;
    grid-template-columns: repeat(8, 60px);
    gap: 16px;
    padding: 32px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
    animation: fadeInUp 0.8s ease-out;
      position: relative;
      }
      
      /* 저작권 표시 */
      #seat-container::after {
        content: '© 2025 Eunsung Lee';
        position: absolute;
        bottom: 8px;
        right: 12px;
        font-size: 11px;
        color: #999;
        font-family: 'Inter', Arial, sans-serif;
        pointer-events: none;
      }
    
    .seat {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 600;
      font-size: 11px;
      user-select: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
      text-align: center;
      line-height: 1.1;
    }
    
    .seat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
      border-radius: 14px;
    }
    
    .seat.male {
      background: linear-gradient(135deg, #667eea, #4facfe);
      box-shadow: 
        0 8px 16px rgba(102, 126, 234, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .seat.female {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      box-shadow: 
        0 8px 16px rgba(240, 147, 251, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .seat:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 
        0 12px 24px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .seat.dragging {
      opacity: 0.5;
      transform: rotate(5deg) scale(1.1);
      z-index: 1000;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .seat.drag-over {
      border: 3px solid #4ade80;
      box-shadow: 
        0 0 20px rgba(74, 222, 128, 0.4),
        0 12px 24px rgba(0, 0, 0, 0.15);
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { 
        border-color: #4ade80;
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.4);
      }
      50% { 
        border-color: #22c55e;
        box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
      }
    }
    
    .empty {
      width: 60px;
      height: 60px;
    }
    
/* 교탁: 색상만 변경 */
.desk {
  grid-column: span 2;
  height: 60px;
  border-radius: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #ffffff;
  font-weight: 700;
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;

  /* 🎨 원하는 색상 팔레트 */
  background: linear-gradient(135deg, #6a11cb, #2575fc); /* 보라→파랑 */
  box-shadow:
    0 8px 16px rgba(37, 117, 252, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);

  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.desk::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
  border-radius: 14px;
}

.desk:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow:
    0 12px 24px rgba(0, 0, 0, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-box {
      background: white;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      max-height: 80vh;
      width: 90%;
      text-align: left;
      animation: scaleIn 0.3s ease-out;
      overflow-y: auto;
    }
    
    .modal-box h2 {
      margin-bottom: 20px;
      color: #2d3748;
      font-weight: 700;
      font-size: 20px;
    }
    
    .modal-box label {
      font-weight: 500;
      display: block;
      margin-bottom: 16px;
      cursor: pointer;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .modal-box input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .modal-box button {
      margin-top: 20px;
      padding: 12px 24px;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .modal-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    .modal-box p {
      line-height: 1.6;
      color: #4a5568;
      margin-bottom: 16px;
    }
    
    /* 이미지 저장용 임시 컨테이너 스타일 */
    #temp-container {
      position: fixed;
      top: -9999px;
      left: -9999px;
      background: white;
      padding: 32px;
      border-radius: 20px;
      display: grid;
      grid-template-columns: repeat(8, 60px);
      gap: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* 프로모션 하단 바 스타일 */
    .promo-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
      padding: 16px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      min-height: 70px;
      overflow: hidden;
      transition: background 0.5s ease;
    }
    
    .promo-bar.hidden {
      display: none;
    }
    
    .promo-slide {
      display: none;
      align-items: center;
      justify-content: flex-start;
      padding: 0 40px;
      animation: fadeIn 0.5s ease-in-out;
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .promo-slide::before,
    .promo-slide::after {
      position: absolute;
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
    }
    
    .promo-emoji {
      position: absolute;
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
    }
    
    /* GitHub Star - 노란색 */
    .promo-slide:nth-child(1) {
      background: #fbbf24;
    }
    
    /* RandomPicker - 파란색 */
    .promo-slide:nth-child(2) {
      background: #3b82f6;
    }
    
    /* Coffee - 갈색 */
    .promo-slide:nth-child(3) {
      background: #92400e;
    }
    
    /* Feedback - 핑크색 */
    .promo-slide:nth-child(4) {
      background: #ec4899;
    }
    
    /* Follow - 보라색 */
    .promo-slide:nth-child(5) {
      background: #8b5cf6;
    }
    
    .promo-slide.active {
      display: flex;
    }
    
    .promo-content {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      height: 100%;
      padding: 0 40px;
      background: transparent;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 22px;
      transition: all 0.3s ease;
      cursor: pointer;
      z-index: 1;
      position: relative;
    }
    

    
    .promo-icon {
      font-size: 48px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
    }
    
    /* 하단 광고바 공간 확보 */
    body {
      padding-bottom: 110px;
    }
    
    .modal-box input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 8px;
      transition: border-color 0.3s;
    }
    
    .modal-box input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .captcha-container {
      margin: 16px 0;
      display: flex;
      justify-content: center;
    }
    
    .error-message {
      color: #e53e3e;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      #seat-container {
        grid-template-columns: repeat(8, 50px);
        gap: 12px;
        padding: 24px;
      }
      
      .seat, .empty {
        width: 50px;
        height: 50px;
        font-size: 10px;
      }
      
      .button {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      #dynamic-island {
        gap: 8px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
<div id="wrapper">
  <div id="dynamic-island">
<div class="button crown" id="crown-button" title="Upgrade to PRO"><i class="fa-solid fa-crown"></i></div>
<div class="button" id="start-button" title="Shuffle"><i class="fa-solid fa-play"></i></div>
<div class="button" id="reset-button" title="Clear"><i class="fa-solid fa-rotate-left"></i></div>
<div class="button" id="photo-button" title="Export"><i class="fa-solid fa-save"></i></div>
<div class="button" id="upload-button" title="Import JSON"><i class="fa-solid fa-file-upload"></i></div>
<div class="button" id="settings-button" title="Settings"><i class="fa-solid fa-gear"></i></div>
<div class="button" id="bug-button" title="Feedback" onclick="location.href='mailto:eunsung_lee@hotmail.com'"><i class="fa-solid fa-bug"></i></div>
<div class="button" id="info-button" title="About"><i class="fa-solid fa-circle-info"></i></div>

  </div>

  <div id="seat-container"></div>
  
</div>

<!-- Promotion Bar -->
<div class="promo-bar">
  <div class="promo-slide active" data-emoji="⭐">
    <span class="promo-emoji" style="font-size: 100px; left: 5%; top: -30px; transform: rotate(-15deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 70px; right: 15%; top: -10px; transform: rotate(20deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 50px; left: 30%; top: -5px; transform: rotate(-25deg);">⭐</span>
    <span class="promo-emoji" style="font-size: 60px; right: 35%; top: -18px; transform: rotate(15deg);">⭐</span>
    <a href="https://github.com/codemaster0524/RandomSeats" target="_blank" class="promo-content">
      <span class="promo-icon">⭐</span>
      <span>Star this project on GitHub</span>
    </a>
  </div>
  <div class="promo-slide" data-emoji="🎲">
    <span class="promo-emoji" style="font-size: 90px; left: 10%; top: -25px; transform: rotate(10deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 65px; right: 8%; top: -20px; transform: rotate(-10deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 55px; left: 35%; top: -8px; transform: rotate(25deg);">🎲</span>
    <span class="promo-emoji" style="font-size: 75px; right: 30%; top: -15px; transform: rotate(-20deg);">🎲</span>
    <a href="https://codemaster0524.github.io/RandomPicker" target="_blank" class="promo-content">
      <span class="promo-icon">🎲</span>
      <span>Try RandomPicker</span>
    </a>
  </div>
  <div class="promo-slide" data-emoji="☕">
    <span class="promo-emoji" style="font-size: 95px; left: 7%; top: -28px; transform: rotate(-12deg);">☕</span>
    <span class="promo-emoji" style="font-size: 75px; right: 10%; top: -12px; transform: rotate(-15deg);">☕</span>
    <span class="promo-emoji" style="font-size: 58px; left: 32%; top: -10px; transform: rotate(18deg);">☕</span>
    <span class="promo-emoji" style="font-size: 68px; right: 33%; top: -20px; transform: rotate(-8deg);">☕</span>
    <div class="promo-content" onclick="showCoffeeModal()">
      <span class="promo-icon">☕</span>
      <span>Buy me a coffee</span>
    </div>
  </div>
  <div class="promo-slide" data-emoji="💌">
    <span class="promo-emoji" style="font-size: 85px; left: 12%; top: -22px; transform: rotate(12deg);">💌</span>
    <span class="promo-emoji" style="font-size: 68px; right: 18%; top: -18px; transform: rotate(-18deg);">💌</span>
    <span class="promo-emoji" style="font-size: 52px; left: 28%; top: -6px; transform: rotate(-22deg);">💌</span>
    <span class="promo-emoji" style="font-size: 72px; right: 28%; top: -14px; transform: rotate(8deg);">💌</span>
    <div class="promo-content" onclick="showFeedbackModal()">
      <span class="promo-icon">💌</span>
      <span>Leave feedback & rating</span>
    </div>
  </div>
  <div class="promo-slide" data-emoji="👤">
    <span class="promo-emoji" style="font-size: 92px; left: 6%; top: -26px; transform: rotate(-20deg);">👤</span>
    <span class="promo-emoji" style="font-size: 72px; right: 14%; top: -14px; transform: rotate(15deg);">👤</span>
    <span class="promo-emoji" style="font-size: 56px; left: 30%; top: -12px; transform: rotate(20deg);">👤</span>
    <span class="promo-emoji" style="font-size: 66px; right: 32%; top: -22px; transform: rotate(-12deg);">👤</span>
    <a href="https://github.com/codemaster0524" target="_blank" class="promo-content">
      <span class="promo-icon">👤</span>
      <span>Follow me on GitHub</span>
    </a>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>

function createFavicons() {
  const timestamp = Date.now();

  const lightFavicon = document.createElement('link');
  lightFavicon.rel = 'icon';
  lightFavicon.type = 'image/svg+xml';
  lightFavicon.media = '(prefers-color-scheme: light)';
  lightFavicon.href = `https://codemaster0524.github.io/RandomSeats/favicon.svg?v=${timestamp}`;

  const darkFavicon = document.createElement('link');
  darkFavicon.rel = 'icon';
  darkFavicon.type = 'image/svg+xml';
  darkFavicon.media = '(prefers-color-scheme: dark)';
  darkFavicon.href = `https://codemaster0524.github.io/RandomSeats/favicon-dark.svg?v=${timestamp}`;

  document.head.appendChild(lightFavicon);
  document.head.appendChild(darkFavicon);
}
createFavicons();

// 페이지 로드시 실행
createFavicons();

let deskVisible = true;
let teacherView = false;
let currentSeatAssignment = null;
let draggedSeat = null;
let isPro = false;
let turnstileWidgetId = null;

// Cloudflare Workers API URL
const WORKER_API_URL = 'https://ad-keys.eunsung-lee-460.workers.dev/';
const TURNSTILE_SITE_KEY = '0x4AAAAAAB6AJ6Melx1ZJUyZ'; // Turnstile 사이트 키

// 페이지 로드시 PRO 상태 확인 (localStorage 사용)
if (localStorage.getItem('isPro') === 'true') {
  isPro = true;
  const promoBar = document.querySelector('.promo-bar');
  if (promoBar) promoBar.classList.add('hidden');
  const crownButton = document.getElementById('crown-button');
  if (crownButton) crownButton.classList.add('pro');
}

// 프로모션 슬라이드 자동 전환 (5초마다)
let currentSlide = 0;
const slides = document.querySelectorAll('.promo-slide');
const promoBar = document.querySelector('.promo-bar');

function showSlide(index) {
  slides.forEach((slide, i) => {
    slide.classList.remove('active');
    if (i === index) {
      slide.classList.add('active');
      // 프로모션 바 배경색 변경
      const bgColor = window.getComputedStyle(slide).backgroundColor;
      promoBar.style.background = bgColor;
    }
  });
}

// 초기 배경색 설정
if (slides.length > 0 && !isPro) {
  const initialBgColor = window.getComputedStyle(slides[0]).backgroundColor;
  promoBar.style.background = initialBgColor;
}

function nextSlide() {
  if (!isPro) {
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
  }
}

setInterval(nextSlide, 5000);

const pattern = [
  'XXITTIXX',
  'OQIOQIOQ',
  'QOIQOIQO',
  'OQIOQIOQ',
  'QOIQOIQO',
  'OQIOOIOQ'
];

const entries = [
  {name: '강태경', gender: 'male'}, {name: '고 율', gender: 'female'},
  {name: '권하은', gender: 'female'}, {name: '김민서', gender: 'female'},
  {name: '김민지', gender: 'female'}, {name: '김윤환', gender: 'male'},
  {name: '류선우', gender: 'male'}, {name: '박종훈', gender: 'male'},
  {name: '박주형', gender: 'male'}, {name: '박지호', gender: 'male'},
  {name: '양서진', gender: 'male'}, {name: '오수빈', gender: 'male'},
  {name: '유은지', gender: 'female'}, {name: '윤경진', gender: 'male'},
  {name: '윤선유', gender: 'female'}, {name: '이소은', gender: 'female'},
  {name: '이은성', gender: 'male'}, {name: '이하윤', gender: 'female'},
  {name: '이현민', gender: 'male'}, {name: '정시목', gender: 'male'},
  {name: '정유현', gender: 'female'}, {name: '정재현', gender: 'male'},
  {name: '정해주', gender: 'female'}, {name: '조수아', gender: 'female'},
  {name: '진혜원', gender: 'female'}, {name: '천마루', gender: 'male'},
  {name: '최선우', gender: 'male'}, {name: '하지현', gender: 'female'},
  {name: '황은아', gender: 'female'}, {name: '황지운', gender: 'male'}
];

const seatContainer = document.getElementById('seat-container');
const startButton = document.getElementById('start-button');
const resetButton = document.getElementById('reset-button');
const photoButton = document.getElementById('photo-button');
const settingsButton = document.getElementById('settings-button');
const infoButton = document.getElementById('info-button');
const wrapper = document.getElementById('wrapper');

function renderEmptySeats() {
  seatContainer.innerHTML = '';
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        seatContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          seatContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.classList.add('desk');
        desk.textContent = '교탁';
        seatContainer.appendChild(desk);
        continue;
      }
      const seat = document.createElement('div');
      seat.classList.add('seat');
      if (ch === 'Q') seat.classList.add('female');
      else if (ch === 'O') seat.classList.add('male');
      seat.textContent = '';
      seatContainer.appendChild(seat);
    }
  }
}

function renderSeatsWithAssignment() {
  seatContainer.innerHTML = '';
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        seatContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          seatContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.classList.add('desk');
        desk.textContent = '교탁';
        seatContainer.appendChild(desk);
        continue;
      }

      const seat = document.createElement('div');
      seat.classList.add('seat');
      if (ch === 'Q') seat.classList.add('female');
      else if (ch === 'O') seat.classList.add('male');

      const occupant = currentSeatAssignment ? currentSeatAssignment[row][col] : null;
      seat.textContent = occupant ? occupant.name : '';

      if (occupant) {
        seat.draggable = true;
        seat.dataset.row = row;
        seat.dataset.col = col;
        seat.dataset.gender = occupant.gender;
        
        seat.addEventListener('dragstart', handleDragStart);
        seat.addEventListener('dragover', handleDragOver);
        seat.addEventListener('drop', handleDrop);
        seat.addEventListener('dragend', handleDragEnd);
        
        seat.style.cursor = 'grab';
      }

      seatContainer.appendChild(seat);
    }
  }
}

function assignSeats() {
  const maleSeats = [], femaleSeats = [];
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'O') maleSeats.push({row, col});
      else if (ch === 'Q') femaleSeats.push({row, col});
    }
  }

  const males = entries.filter(e => e.gender === 'male');
  const females = entries.filter(e => e.gender === 'female');
  const shuffle = arr => arr.sort(() => Math.random() - 0.5);
  const shuffledMales = shuffle([...males]);
  const shuffledFemales = shuffle([...females]);

  const seatMap = Array(pattern.length).fill(null).map(() => Array(pattern[0].length).fill(null));
  for (let i = 0; i < maleSeats.length; i++) {
    if (i < shuffledMales.length)
      seatMap[maleSeats[i].row][maleSeats[i].col] = shuffledMales[i];
  }
  for (let i = 0; i < femaleSeats.length; i++) {
    if (i < shuffledFemales.length)
      seatMap[femaleSeats[i].row][femaleSeats[i].col] = shuffledFemales[i];
  }

  currentSeatAssignment = seatMap;
  renderSeatsWithAssignment();
}

// 드래그 앤 드롭 이벤트 핸들러들
function handleDragStart(e) {
  draggedSeat = {
    row: parseInt(e.target.dataset.row),
    col: parseInt(e.target.dataset.col),
    gender: e.target.dataset.gender,
    element: e.target
  };
  e.target.classList.add('dragging');
  e.target.style.cursor = 'grabbing';
}

function handleDragOver(e) {
  e.preventDefault();
  const targetGender = e.target.dataset.gender;
  
  if (draggedSeat && targetGender && draggedSeat.gender === targetGender) {
    e.target.classList.add('drag-over');
  }
}

function handleDrop(e) {
  e.preventDefault();
  
  if (!draggedSeat || !e.target.dataset.gender) return;
  
  const targetRow = parseInt(e.target.dataset.row);
  const targetCol = parseInt(e.target.dataset.col);
  const targetGender = e.target.dataset.gender;
  
  if (draggedSeat.gender === targetGender) {
    const temp = currentSeatAssignment[draggedSeat.row][draggedSeat.col];
    currentSeatAssignment[draggedSeat.row][draggedSeat.col] = currentSeatAssignment[targetRow][targetCol];
    currentSeatAssignment[targetRow][targetCol] = temp;
    
    renderSeatsWithAssignment();
  }
  
  cleanupDragState();
}

function handleDragEnd(e) {
  cleanupDragState();
}

function cleanupDragState() {
  if (draggedSeat) {
    draggedSeat.element.classList.remove('dragging');
    draggedSeat.element.style.cursor = 'grab';
  }
  
  document.querySelectorAll('.drag-over').forEach(seat => {
    seat.classList.remove('drag-over');
  });
  
  draggedSeat = null;
}

// 이미지 저장을 위한 임시 컨테이너 생성 함수
function createTempContainer() {
  const tempContainer = document.createElement('div');
  tempContainer.id = 'temp-container';
  
  // 쌤 뷰가 활성화되어 있으면 임시 컨테이너도 회전
  if (teacherView) {
    tempContainer.style.transform = 'rotate(180deg)';
  }
  
  // 현재 좌석 배치를 복사
  for (let row = 0; row < pattern.length; row++) {
    for (let col = 0; col < pattern[row].length; col++) {
      const ch = pattern[row][col];
      if (ch === 'X' || ch === 'I') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.style.width = '60px';
        empty.style.height = '60px';
        tempContainer.appendChild(empty);
        continue;
      }
      if (ch === 'T') {
        if (!deskVisible) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.style.width = '60px';
          empty.style.height = '60px';
          tempContainer.appendChild(empty);
          continue;
        }
        if (col > 0 && pattern[row][col - 1] === 'T') continue;
        const desk = document.createElement('div');
        desk.style.cssText = `
          grid-column: span 2;
          height: 60px;
          border-radius: 16px;
          display: flex;
          justify-content: center;
          align-items: center;
          color: #ffffff;
          font-weight: 700;
          font-size: 14px;
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          box-shadow: 0 8px 16px rgba(37, 117, 252, 0.3);
          ${teacherView ? 'transform: rotate(180deg);' : ''}
        `;
        desk.textContent = '교탁';
        tempContainer.appendChild(desk);
        continue;
      }

      const seat = document.createElement('div');
      seat.style.cssText = `
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        font-size: 11px;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        text-align: center;
        line-height: 1.1;
        ${teacherView ? 'transform: rotate(180deg);' : ''}
      `;
      
      if (ch === 'Q') {
        seat.style.background = 'linear-gradient(135deg, #f093fb, #f5576c)';
        seat.style.boxShadow = '0 8px 16px rgba(240, 147, 251, 0.3)';
      } else if (ch === 'O') {
        seat.style.background = 'linear-gradient(135deg, #667eea, #4facfe)';
        seat.style.boxShadow = '0 8px 16px rgba(102, 126, 234, 0.3)';
      }

      const occupant = currentSeatAssignment ? currentSeatAssignment[row][col] : null;
      seat.textContent = occupant ? occupant.name : '';

      tempContainer.appendChild(seat);
    }
  }
  
  document.body.appendChild(tempContainer);
  return tempContainer;
}

const crownButton = document.getElementById('crown-button');
const uploadButton = document.getElementById('upload-button');
// 왕관 버튼 클릭 (PRO 구매)
crownButton.onclick = () => {
  if (isPro) {
    alert('✨ You are already a PRO user!');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>🌟 Upgrade to RandomSeats PRO</h2>
    <p style="margin-bottom: 16px;">Unlock premium features:</p>
    <ul style="margin: 16px 0; line-height: 1.8;">
      <li>✅ <strong>JSON Import/Export</strong> - Save and load seating arrangements</li>
      <li>✅ <strong>Teacher View</strong> - 180° rotation for instructor's perspective</li>
      <li>✅ <strong>Ad-Free Experience</strong> - Remove all promotional content</li>
      <li>✅ <strong>Future Updates</strong> - Access to upcoming PRO features</li>
    </ul>
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enter PRO License Key</label>
      <input type="text" id="pro-key-input" placeholder="XXXXX-XXXXX-XXXXX-XXXXX-XXXXX" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: monospace;" />
      <div class="error-message" id="pro-key-error"></div>
      <div class="captcha-container" id="pro-captcha-container">
        <div id="pro-turnstile-widget"></div>
      </div>
      <button id="activate-pro-button" style="margin-top: 12px;">Activate PRO</button>
    </div>
    <button id="close-pro-modal" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Turnstile 위젯 렌더링
  setTimeout(() => {
    if (typeof turnstile !== 'undefined') {
      turnstileWidgetId = turnstile.render('#pro-turnstile-widget', {
        sitekey: TURNSTILE_SITE_KEY,
        theme: 'light',
      });
    }
  }, 100);


  e.preventDefault();

  const proKeyInput = box.querySelector('#pro-key-input');
  const activateButton = box.querySelector('#activate-pro-button');
  const keyError = box.querySelector('#pro-key-error');
  
  activateButton.onclick = async () => {
  e.preventDefault(); // 🚀 form의 기본 동작(새로고침 + GET요청) 막기

    
    const key = proKeyInput.value.trim();
    
    if (!key) {
      keyError.textContent = 'Please enter a PRO license key';
      keyError.classList.add('show');
      return;
    }
    
    let captchaToken;
    try {
      captchaToken = turnstile.getResponse(turnstileWidgetId);
      if (!captchaToken) {
        keyError.textContent = 'Please complete the captcha';
        keyError.classList.add('show');
        return;
      }
    } catch (e) {
      keyError.textContent = 'Captcha error. Please refresh the page.';
      keyError.classList.add('show');
      return;
    }
    
    activateButton.disabled = true;
    activateButton.textContent = 'Verifying...';
    keyError.classList.remove('show');
    
    try {
      const response = await fetch(WORKER_API_URL, {
        method: 'POST',
          mode: 'cors', // ✅ 이 줄 추가!!
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, captchaToken }),
      });
      
      const result = await response.json();
      
      if (result.success) {
        localStorage.setItem('isPro', 'true');
        isPro = true;
        
        const promoBar = document.querySelector('.promo-bar');
        if (promoBar) promoBar.classList.add('hidden');
        
        crownButton.classList.add('pro');
        
        document.body.removeChild(modal);
        alert('🎉 Welcome to RandomSeats PRO! All premium features are now unlocked.');
      } else {
        keyError.textContent = result.error || 'Invalid PRO key';
        keyError.classList.add('show');
        activateButton.disabled = false;
        activateButton.textContent = 'Activate PRO';
        turnstile.reset(turnstileWidgetId);
      }
    } catch (error) {
      keyError.textContent = 'Network error. Please try again.';
      keyError.classList.add('show');
      activateButton.disabled = false;
      activateButton.textContent = 'Activate PRO';
      if (turnstileWidgetId) turnstile.reset(turnstileWidgetId);
    }
  };
  
  box.querySelector('#close-pro-modal').onclick = () => document.body.removeChild(modal);
};

// JSON 업로드 (PRO 전용)
uploadButton.onclick = () => {
  if (!isPro) {
    alert('🌟 This is a PRO feature. Please upgrade to use JSON Import/Export.');
    crownButton.click();
    return;
  }
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        currentSeatAssignment = JSON.parse(ev.target.result);
        renderSeatsWithAssignment();
      } catch {
        alert("Invalid JSON file format.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

startButton.onclick = () => assignSeats();
resetButton.onclick = () => renderEmptySeats();

// 커피 모달
function showCoffeeModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>☕ Buy Me a Coffee</h2>
    <p>Support the developer to create better projects!</p>
    <p style="margin-top: 16px;">🎁 <strong>QR code coming soon!</strong></p>
    <button id="close-coffee">Close</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  box.querySelector('#close-coffee').onclick = () => document.body.removeChild(modal);
}

// 피드백 모달
function showFeedbackModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const box = document.createElement('div');
  box.className = 'modal-box';
  box.innerHTML = `
    <h2>💌 Feedback & Rating</h2>
    <p style="margin-bottom: 16px;">How do you like RandomSeats?</p>
    <div style="text-align: center; margin: 24px 0; font-size: 32px;">
      <span class="star" data-rating="1">⭐</span>
      <span class="star" data-rating="2">⭐</span>
      <span class="star" data-rating="3">⭐</span>
      <span class="star" data-rating="4">⭐</span>
      <span class="star" data-rating="5">⭐</span>
    </div>
    <textarea id="feedback-text" placeholder="Leave your feedback (optional)" style="width: 100%; min-height: 100px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; font-family: inherit;"></textarea>
    <button id="submit-feedback" style="margin-top: 12px;">Submit</button>
    <button id="close-feedback" style="background: #e2e8f0; color: #4a5568;">Close</button>
  `;
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  let selectedRating = 0;
  box.querySelectorAll('.star').forEach(star => {
    star.style.cursor = 'pointer';
    star.style.opacity = '0.3';
    star.style.transition = 'opacity 0.2s';
    star.onclick = () => {
      selectedRating = parseInt(star.dataset.rating);
      box.querySelectorAll('.star').forEach((s, i) => {
        s.style.opacity = i < selectedRating ? '1' : '0.3';
      });
    };
  });
  
  box.querySelector('#submit-feedback').onclick = () => {
    if (selectedRating === 0) {
      alert('Please select a rating!');
      return;
    }
    alert(`✨ Thank you for your feedback! (${selectedRating}⭐)`);
    document.body.removeChild(modal);
  };
  
  box.querySelector('#close-feedback').onclick = () => document.body.removeChild(modal);
}

photoButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Export Options</h2>
  <button id="save-png">Export as PNG</button>
  <button id="save-json" ${!isPro ? 'disabled title="PRO feature"' : ''}>Export as JSON ${!isPro ? '👑' : ''}</button>
  <button id="close-save">Cancel</button>
  `;

  box.querySelector('#save-png').onclick = () => {
    if (!currentSeatAssignment) {
      alert("No seat arrangement. Please assign seats first.");
      document.body.removeChild(modal);
      return;
    }

    // 임시 컨테이너 생성
    const tempContainer = createTempContainer();
    
    // html2canvas로 캡처
    html2canvas(tempContainer, {
      backgroundColor: 'white',
      scale: 2,
      useCORS: true,
      allowTaint: false,
      foreignObjectRendering: false,
      logging: false,
      width: tempContainer.scrollWidth,
      height: tempContainer.scrollHeight
    }).then(canvas => {
      // 저작권 표시 추가
      const ctx = canvas.getContext('2d');
      ctx.font = '14px Inter, Arial';
      ctx.fillStyle = '#999';
      ctx.textAlign = 'right';
      ctx.fillText('© 2025 Eunsung Lee', canvas.width - 20, canvas.height - 15);
      // 임시 컨테이너 제거
      document.body.removeChild(tempContainer);
      
      // 다운로드 링크 생성
      const link = document.createElement('a');
      link.download = `seat_arrangement_${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      document.body.removeChild(modal);
    }).catch(error => {
      // 오류 시 임시 컨테이너 정리
      if (document.body.contains(tempContainer)) {
        document.body.removeChild(tempContainer);
      }
      console.error('이미지 저장 오류:', error);
      alert('An error occurred while saving the image. Please refresh and try again.');
      document.body.removeChild(modal);
    });
  };

  box.querySelector('#save-json').onclick = () => {
    if (!isPro) {
      alert('🌟 JSON Export is a PRO feature. Please upgrade to RandomSeats PRO.');
      document.body.removeChild(modal);
      crownButton.click();
      return;
    }
    if (!currentSeatAssignment) {
      alert("No seat arrangement to export.");
      document.body.removeChild(modal);
      return;
    }
    const blob = new Blob([JSON.stringify(currentSeatAssignment, null, 2)], {type: "application/json"});
    const link = document.createElement('a');
    link.download = `seat_arrangement_${new Date().toISOString().slice(0,10)}.json`;
    link.href = URL.createObjectURL(blob);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href); // 메모리 정리
    document.body.removeChild(modal);
  };

  box.querySelector('#close-save').onclick = () => document.body.removeChild(modal);
  modal.appendChild(box);
  document.body.appendChild(modal);
};

settingsButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Settings</h2>
  <label><input type="checkbox" id="desk-toggle" ${deskVisible ? 'checked' : ''}> Show Teacher Desk</label>
  <label><input type="checkbox" id="teacher-view-toggle" ${teacherView ? 'checked' : ''} ${!isPro ? 'disabled' : ''}> Teacher View (Rotate 180°) ${!isPro ? '<span style="color: #f59e0b; font-size: 12px;">👑 PRO</span>' : ''}</label>

  <button id="close-settings">Close</button>
`;


  const deskToggle = box.querySelector('#desk-toggle');
  const teacherViewToggle = box.querySelector('#teacher-view-toggle');

  deskToggle.onchange = () => {
    deskVisible = deskToggle.checked;
    if (currentSeatAssignment) {
      renderSeatsWithAssignment();
    } else {
      renderEmptySeats();
    }
  };

  teacherViewToggle.onchange = () => {
    if (!isPro) {
      alert('🌟 Teacher View is a PRO feature. Please upgrade to RandomSeats PRO.');
      teacherViewToggle.checked = false;
      crownButton.click();
      return;
    }
    teacherView = teacherViewToggle.checked;
    if (teacherView) {
      wrapper.classList.add('teacher-view');
    } else {
      wrapper.classList.remove('teacher-view');
    }
  };

  box.querySelector('#close-settings').onclick = () => document.body.removeChild(modal);

  modal.appendChild(box);
  document.body.appendChild(modal);
};

infoButton.onclick = () => {
  const modal = document.createElement('div');
  modal.className = 'modal';

  const box = document.createElement('div');
  box.className = 'modal-box';
box.innerHTML = `
  <h2>Seat Arrangement System v2.8.1</h2>
  <p><strong>Created by:</strong> Eunsung Lee</p>
  <p>A smart and intuitive tool for managing classroom seating arrangements.</p>
  <p><strong>Key Features:</strong></p>
  <ul>
    <li>Automatic random assignment by gender</li>
    <li>Simple drag & drop seat swapping</li>
    <li>Teacher View (180° rotation for instructor’s perspective)</li>
    <li>Export and Import as high-resolution PNG or JSON</li>
    <li>Responsive design for desktop and mobile</li>
  </ul>
  <p><strong>Latest Update:</strong> Teacher View export support, improved UI/UX</p>
  <p><strong>License:</strong> CC BY-NC-ND 4.0</p>
  <p>Free for educational and non-commercial use. For commercial use, please contact the author.</p>
  <button id="close-info">Close</button>
`;


  box.querySelector('#close-info').onclick = () => document.body.removeChild(modal);

  modal.appendChild(box);
  document.body.appendChild(modal);
};

renderEmptySeats();
</script>


</body>
</html>
